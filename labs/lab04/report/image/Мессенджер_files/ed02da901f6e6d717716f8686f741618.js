(self.webpackChunkvk=self.webpackChunkvk||[]).push([[87586],{60741:(e,t,o)=>{"use strict";o.d(t,{photos:()=>X});o(30522),o(50110),o(21466),o(51876),o(59357);var r,i=o(15544),n=o(26271),a=o(40906),s=o(35676),l=o(66890),d=o(35429),c=o(86125),u=o(49535),h=o(95724),p=o(3834),g=o(86409),_=o(54612),f=o(70655),v=o(20820);!function(e){e[e.Initial=0]="Initial",e[e.Confirmed=1]="Confirmed",e[e.Declined=2]="Declined"}(r||(r={}));var m,w=function(){function e(e,t){this.tagEl=e,this.tagArea=t;var o=e.getAttribute("data-item");if(!o)throw new Error("Tag: incorrect json data");var i=JSON.parse(o);this.id=Number(i.id),this.userId=i.userId,this.name=i.name,this.nameGenitive=i.nameGenitive,this.ownerNameGenitive=i.ownerNameGenitive,this.placerNameGenitive=i.placerNameGenitive,this.nameAccusative=i.nameAccusative,this.isSuggested=Boolean(i.isSuggested),this.sex=Number(i.sex),this.styles={top:i.top,left:i.left,width:i.width,height:i.height};var n=r.Initial;e.classList.contains("PhotoTag--confirm")?n=r.Confirmed:e.classList.contains("PhotoTag--decline")&&(n=r.Declined),this.state=n;var a="tag_cutout"+t.getPhotoRawId()+"_"+i.userId,s=document.getElementById(a);if(!s)throw new Error("Tag: incorrect data");this.cutoutEl=s}return e.prototype.decline=function(){this.tagEl.classList.remove("PhotoTag--confirm"),this.tagEl.classList.add("PhotoTag--decline"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=r.Declined},e.prototype.confirm=function(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.add("PhotoTag--confirm"),this.cutoutEl.classList.add("PhotoTagCutout--transparency"),this.state=r.Confirmed},e.prototype.reset=function(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.remove("PhotoTag--confirm"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=r.Initial},e.prototype.getFullRawId=function(){return this.tagArea.getPhotoRawId()+"_"+this.getId()},e.prototype.getId=function(){return this.id},e.prototype.getUserId=function(){return this.userId},e.prototype.getUserName=function(){return this.name},e.prototype.getUserNameGenitive=function(){return this.nameGenitive},e.prototype.getUserNameAccusative=function(){return this.nameAccusative},e.prototype.getOwnerNameGenitive=function(){return this.ownerNameGenitive},e.prototype.getPlacerNameGenitive=function(){return this.placerNameGenitive},e.prototype.isConfirmed=function(){return this.state===r.Confirmed},e.prototype.getSex=function(){return this.sex},e}(),E=o(19331),C=o(86067),b=o(65931),y=function(){function e(e,t,o){var r=this;this.confirmTag=function(e,t,o){o&&(0,g.lockButton)(o);var i=!(0,E.partConfigEnabled)("recognize_mock_turn_off");return new Promise((function(n,a){window.ajax.post("al_photos.php",{act:"confirm_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:r.tagHash},{onDone:function(){r.setConfirmedTags([e]),r.decrementLeftMenuCounterIfNeeded([e]),n()},onFail:function(){return i?(r.setConfirmedTags([e]),n(),!0):((0,c.showDoneBox)((0,C.getLang)("global_unknown_error")),a(),!0)},hideProgress:function(){o&&(0,g.unlockButton)(o)}})}))},this.declineTag=function(e,t,o){return new Promise((function(i,n){o&&(0,g.lockButton)(o);var a=!(0,E.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"delete_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:r.tagHash},{onDone:function(){r.setDeclinedTags([e]),r.decrementLeftMenuCounterIfNeeded([e]),i()},onFail:function(){return a?(r.setDeclinedTags([e]),i(),!0):((0,c.showDoneBox)((0,C.getLang)("global_unknown_error")),n(),!0)},hideProgress:function(){o&&(0,g.unlockButton)(o)}})}))},this.confirmSuggestedTags=function(e,t,o){return r.showConfirmAlertBoxIfNeeded(e).then((function(){o&&(0,g.lockButton)(o);var t=!(0,E.partConfigEnabled)("recognize_mock_turn_off");return new Promise((function(i,n){window.ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:r.getFullRawTagIdsStr(e),track_code:r.trackCode,hash:r.tagHash},{onDone:function(){r.setConfirmedTags(e),r.decrementLeftMenuCounterIfNeeded(e),i()},onFail:function(){return t?(r.setConfirmedTags(e),i(),!0):((0,c.showDoneBox)((0,C.getLang)("global_unknown_error")),n(),!0)},hideProgress:function(){o&&(0,g.unlockButton)(o)}})}))}))},this.declineSuggestedTags=function(e,t,o){return new Promise((function(t,i){o&&(0,g.lockButton)(o);var n=!(0,E.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:r.getFullRawTagIdsStr(e),track_code:r.trackCode,hash:r.tagHash},{onDone:function(){r.setDeclinedTags(e),r.decrementLeftMenuCounterIfNeeded(e),t()},onFail:function(){return n?(r.setDeclinedTags(e),t(),!0):((0,c.showDoneBox)((0,C.getLang)("global_unknown_error")),i(),!0)},hideProgress:function(){o&&(0,g.unlockButton)(o)}})}))};var i=e.getEl().querySelector(".PhotoTagArea");if(!i)throw new Error("error: there is not tag area el");if(!t)throw new Error("error: there is not tag hash");var n=Array.from(e.getEl().querySelectorAll(".PhotoTag"));this.trackCode=o,this.tagArea=i,this.tagHash=t,this.photoEntity=e,this.tags=n.map((function(e){return new w(e,r)})),this.tagsMap=this.tags.reduce((function(e,t){return e[t.getId()]=t,e}),{})}return e.prototype.showConfirmAlertBoxIfNeeded=function(e){var t=this,o=e[0];return new Promise((function(e,r){if(window.cur.pvNeedShowAlertForOneSuggest&&o.getUserId()!==window.vk.id)var i=(0,C.getLang)("photo_recognition_one_tag_alert"),n=(0,C.langSex)(o.getSex(),(0,C.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",o.getUserName()),a=(0,_.showFastBox)(i,n,(0,C.getLang)("photo_recognition_one_friend_submit_btn"),(function(){t.hideHint(),a.hide(),e()}),(0,C.getLang)("global_cancel"),(function(){a.hide(),r()}));else e()}))},e.prototype.hideHint=function(){window.cur.pvNeedShowAlertForOneSuggest=!1;var e=window.cur.pvOneSuggestHintId,t=window.cur.pvOneSuggestHintHash;e&&t&&window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:e,hash:t},{onDone:function(){},onFail:function(){return console.error("something wrong with help hint"),!0}})},e.prototype.decrementLeftMenuCounterIfNeeded=function(e){e.forEach((function(e){e.getUserId()===window.vk.id&&(0,b.decrementLeftMenuPhotoCounter)()}))},e.prototype.getFullRawTagIdsStr=function(e){return void 0===e&&(e=this.tags),e.reduce((function(e,t,o){return e+(0===o?"":",")+t.getFullRawId()}),"")},e.prototype.setConfirmedTagsByIds=function(e){var t=this,o=e.reduce((function(e,o){return t.tagsMap[o]&&e.push(t.tagsMap[o]),e}),[]);return!!o.length&&(this.setConfirmedTags(o),!0)},e.prototype.setConfirmedTags=function(e){var t=this;(e=e.filter((function(e){return t.tagsMap[e.getId()]}))).length&&(e.forEach((function(e){return e.confirm()})),this.tagArea.classList.add("PhotoTagArea--fade"))},e.prototype.setDeclinedTags=function(e){e.forEach((function(e){return e.decline()}))},e.prototype.setDeclinedTagsByIds=function(e){var t=this,o=e.reduce((function(e,o){return t.tagsMap[o]&&e.push(t.tagsMap[o]),e}),[]);return!!o.length&&(this.setDeclinedTags(o),!0)},e.prototype.reset=function(){this.tagArea.classList.remove("PhotoTagArea--fade"),this.tags.forEach((function(e){return e.reset()}))},e.prototype.getPhotoRawId=function(){return this.photoEntity.getPhotoRawId()},e.prototype.getTags=function(){return this.tags},e.prototype.getConfirmedTags=function(){return this.tags.filter((function(e){return e.isConfirmed()}))},e.prototype.setSizes=function(e,t){this.tagArea.style.width=e+"px",this.tagArea.style.height=t+"px"},e.prototype.show=function(){this.tagArea.classList.remove("PhotoTagArea--hide")},e.calculateTagAreaSizes=function(e,t,o){var r,i,n=e.offsetWidth,a=e.offsetHeight,s=t/o,l=!0;return n/a>s&&(l=!1),l?(r=Math.round(Math.min(t,n)),i=Math.round(r/s)):(i=Math.round(Math.min(o,a)),r=Math.round(i*s)),[r,i]},e}(),T=o(50167),L=o(91525),P=o(91789),A="PhotoTagCard--noSize";!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.CONFIRMED=1]="CONFIRMED",e[e.DECLINED=2]="DECLINED",e[e.DELETED=3]="DELETED"}(m||(m={}));var S,D=function(){function e(e){var t=this;this.status=m.ACTIVE,this.isLoading=!1,this.onPhotoClick=function(e){e.ctrlKey||e.metaKey||(t.showPhoto(e),(0,u.cancelEvent)(e))},this.onConfirmClick=function(){t.confirm().then((function(){var e=t.getTags();t.tagArea.setConfirmedTags(e),t.updatePhotoviewCache(!0),t.setViewStatus(m.CONFIRMED)}),(function(e){e&&(0,L.logError)(e)})).finally((function(){t.isLoading=!1}))},this.onDeclineClick=function(){t.isLoading||(t.isLoading=!0,t.decline().then((function(){t.setOverlay(),t.updatePhotoviewCache(!0),t.setViewStatus(m.DECLINED)}),(function(e){e&&(0,L.logError)(e)})).finally((function(){t.isLoading=!1})))},this.onCancelClick=function(){t.setOverlay(!1),t.tagArea.reset(),t.setViewStatus(m.ACTIVE)},this.el=e;var o=e.dataset.photoViewOptions,r=e.dataset.photoContext,i=e.dataset.photoRawId,n=o&&(0,v.parseJSON)(o),a=e.dataset.tagHash;if(!(n&&i&&r&&a))throw new Error("PhotoTagCard: incorrect arguments");var s=(0,f.__read)(i.split("_"),2),l=s[0],d=s[1];this.ownerId=Number(l),this.photoId=Number(d),this.photoRawId=i,this.photoContext=r,this.photoViewOptions=n,this.photoUrl=e.dataset.photoUrl;var c=e.querySelector(".PhotoTagCard__button--confirm"),h=e.querySelector(".PhotoTagCard__button--decline"),p=e.querySelector(".PhotoTagCard__button--cancelConfirm"),g=e.querySelector(".PhotoTagCard__button--cancelDecline"),_=e.querySelector(".PhotoTagCard__desc"),w=e.querySelector(".PhotoTagCard__photo"),E=e.querySelector(".PhotoTagCard__result");if(!(c&&h&&_&&w&&E))throw new Error("PhotoTagCard: there are not elements");this.photoEl=w,this.confirmBtn=c,this.declineBtn=h,this.description=_,this.cancelConfirmBtn=p,this.cancelDeclineBtn=g,this.resultPanel=E,this.tagArea=new y(this,a),this.init()}return e.prototype.destroy=function(){this.deInitListeners()},e.prototype.getPhotoRawId=function(){return this.photoRawId},e.prototype.getEl=function(){return this.photoEl},e.prototype.setConfirmedTagsByIds=function(e){this.tagArea.setConfirmedTagsByIds(e)&&this.setViewStatus(m.CONFIRMED)},e.prototype.setDeclinedTagsByIds=function(e){this.tagArea.setDeclinedTagsByIds(e)&&(this.setOverlay(),this.setViewStatus(m.DECLINED))},e.prototype.setDeletedTagsByIds=function(e){this.tagArea.setDeclinedTagsByIds(e)&&this.setViewStatus(m.DELETED)},e.isPhotoSuggestedTagCard=function(e){return Boolean(Number(e.dataset.isSuggest))},e.prototype.init=function(){this.initListeners(),this.photoUrl&&this.checkPhotoHasNoSizes()&&this.correctTagView(this.photoUrl)},e.prototype.initListeners=function(){var e,t;this.confirmBtn.addEventListener("click",this.onConfirmClick),this.declineBtn.addEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.addEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.addEventListener("click",this.onCancelClick),this.photoEl.addEventListener("click",this.onPhotoClick)},e.prototype.deInitListeners=function(){var e,t;this.confirmBtn.removeEventListener("click",this.onConfirmClick),this.declineBtn.removeEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.removeEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.removeEventListener("click",this.onCancelClick),this.photoEl.removeEventListener("click",this.onPhotoClick)},e.prototype.setViewStatus=function(e){var t=this.resultPanel.querySelector(".PhotoTagCard__resultWrapper");if(t){if(this.status=e,e===m.ACTIVE)return(0,i.hide)(this.resultPanel),void(0,i.show)(this.description);t.innerHTML=this.getResultText(e),(0,i.hide)(this.description),e===m.CONFIRMED?(this.resultPanel.classList.add("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")):e===m.DECLINED?(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.add("PhotoTagCard__result--decline")):(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")),(0,i.show)(this.resultPanel)}},e.prototype.setOverlay=function(e){void 0===e&&(e=!1),this.photoEl.classList.toggle("PhotoTagCard__photo--disable",e)},e.prototype.showPhoto=function(e){(0,T.showPhoto)(this.photoRawId,this.photoContext,this.photoViewOptions,e),this.updatePhotoviewCache()},e.prototype.getTags=function(){return this.tagArea.getTags()},e.prototype.getConfirmedTags=function(){return this.tagArea.getConfirmedTags()},e.prototype.updatePhotoviewCache=function(e){void 0===e&&(e=!1),this.photoViewOptions.noCache=e,e&&(0,P.dropPhotoCacheData)()},e.prototype.checkPhotoHasNoSizes=function(){return this.el.classList.contains(A)},e.prototype.correctTagView=function(e){var t=this,o=new Image;o.onload=function(){var r=o.width,i=o.height;if(r&&i){var n=(0,f.__read)(y.calculateTagAreaSizes(t.photoEl,r,i),2),a=n[0],s=n[1],l=t.el.querySelector(".PhotoTagCard__stub");l&&l.remove();var d=document.createElement("div");d.classList.add("PhotoTagCard__image"),d.style.backgroundSize=a+"px "+s+"px",d.style.backgroundImage="url('"+e+"')",t.photoEl.appendChild(d);var c=a+1,u=s+1;t.tagArea.setSizes(c,u),t.tagArea.show(),t.el.classList.remove(A)}},o.src=e},e.prototype.getOwnerId=function(){return this.ownerId},e.prototype.isActive=function(){return this.status===m.ACTIVE},e}(),x=o(23251),B=function(e){function t(t){return e.call(this,t)||this}return(0,f.__extends)(t,e),t.prototype.confirm=function(){var e=this.getTags();return this.tagArea.confirmTag(e[0],this,this.confirmBtn)},t.prototype.decline=function(){var e=this.getTags();return this.tagArea.declineTag(e[0],this,this.declineBtn)},t.prototype.getResultText=function(e){var t=this.getTags()[0].getPlacerNameGenitive()||"",o="";switch(e){case m.CONFIRMED:o=(0,C.getLang)("photo_recognition_confirm_myself").replace("{name}",t);break;case m.DECLINED:o=(0,C.getLang)("photo_recognition_decline_myself").replace("{name}",t);break;default:o=(0,C.getLang)("photo_recognition_deleted_tag")}return o},t}(D),k=function(e){function t(t){return e.call(this,t)||this}return(0,f.__extends)(t,e),t.prototype.confirm=function(){return this.tagArea.confirmSuggestedTags(this.getTags(),this,this.confirmBtn)},t.prototype.decline=function(){return this.tagArea.declineSuggestedTags(this.getTags(),this,this.declineBtn)},t.prototype.getResultText=function(e){var t=this.getOwnerId(),o=this.tagArea.getTags()[0].getOwnerNameGenitive(),r="";switch(e){case m.CONFIRMED:r=(r=t>0?(0,C.getLang)("photo_recognition_confirm_myself_on_photo"):(0,C.getLang)("photo_recognition_confirm_myself_on_photo_group")).replace("{name}",o);break;case m.DECLINED:r=(r=t>0?(0,C.getLang)("photo_recognition_decline_on_photo"):(0,C.getLang)("photo_recognition_decline_on_photo_group")).replace("{name}",o);break;default:r=(0,C.getLang)("photo_recognition_deleted_tag")}return r},t}(D),U=o(9720),I=o(6593),O=function(){function e(e,t){var o=this;this.isLoading=!1,this.isDestroyed=!1,this.handleOutsideConfirmationSuggestedTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setConfirmedTagsByIds(r)}))},this.handleOutsideDeclinationSuggestedTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setDeclinedTagsByIds(r)}))},this.handleOutsideConfirmationUserTag=function(e){var t=e.detail.photoRawId,r=e.detail.tagId,i=o.cards.find((function(e){return e.getPhotoRawId()===t}));i&&i.setConfirmedTagsByIds([r])},this.handleOutsideDeclinationUserTag=function(e){var t=e.detail.photoRawId,r=e.detail.tagId,i=o.cards.find((function(e){return e.getPhotoRawId()===t}));i&&i.setDeclinedTagsByIds([r])},this.handleOutsideDeletingTags=function(e){var t=e.detail.photoRawId,r=e.detail.tagIds;o.cards.filter((function(e){return e.getPhotoRawId()===t})).forEach((function(e){return e.setDeletedTagsByIds(r)}))},this.checkScroll=(0,U.debounce)((function(){o.isLoading||window.innerHeight+window.pageYOffset+700>=o.cardsBlock.getBoundingClientRect().bottom&&o.loadMore()}),200),this.loadMore=function(){!o.isLoading&&o.nextOffset&&(o.isLoading=!0,window.ajax.post("al_photos.php",{act:"recognition_tags",part:1,offset:o.nextOffset,is_full_page:Number(o.isFullPage)},{onDone:function(e,t,r){var n;if(o.isLoading=!1,!o.isDestroyed){o.fullCardsNumber=t,o.nextOffset=r,o.nextOffset||document.removeEventListener("scroll",o.checkScroll);var a=null==e?void 0:e.map((function(e){var t=(0,i.se)(e);return o.cardsBlock.appendChild(t),t}));(null==a?void 0:a.length)&&(n=o.cards).push.apply(n,(0,f.__spreadArray)([],(0,f.__read)(o.createCards(a)),!1)),r||(0,i.hide)(o.loadMoreBtn)}},showProgress:function(){return(0,g.lockButton)(o.loadMoreBtn)},hideProgress:function(){return(0,g.unlockButton)(o.loadMoreBtn)}}))},this.getAllTagElements=function(e){return Array.from(e.querySelectorAll(".PhotoTagCard"))},this.onConfirmAll=function(){if(o.confirmAllHash){var e=o.getActiveCardsNumber();window.ajax.post("al_photos.php",{act:"confirm_all_tags",hash:o.confirmAllHash},{onDone:function(){o.onSubmitAll(e,(0,C.getLang)("photo_tags_confirmed_text",e))},onFail:function(e){return(0,_.showFastBox)((0,C.getLang)("global_error"),e||(0,C.getLang)("global_unknown_error")),!0},showProgress:function(){return o.confirmAllBtn&&I.FlatButton.lock(o.confirmAllBtn)},hideProgress:function(){return o.confirmAllBtn&&I.FlatButton.unlock(o.confirmAllBtn)}})}},this.onDeclineAll=function(){if(o.declineAllHash){var e=o.getActiveCardsNumber();(0,_.showFastBox)((0,C.getLang)("photo_tag_decline_box_title",e),(0,C.getLang)("photo_tag_decline_box_description"),(0,C.getLang)("photo_recognition_decline_all"),(function(t){!function(t){window.ajax.post("al_photos.php",{act:"decline_all_tags",hash:o.declineAllHash},{onDone:function(){o.onSubmitAll(e,(0,C.getLang)("photo_tags_declined_text",e))},onFail:function(e){return(0,_.showFastBox)((0,C.getLang)("global_error"),e||(0,C.getLang)("global_unknown_error")),!0},showProgress:function(){return(0,g.lockButton)(t)},hideProgress:function(){return(0,g.unlockButton)(t)}})}(t)}),(0,C.getLang)("global_cancel"))}},this.block=e,this.isFullPage=t.isFullPage,this.fullCardsNumber=t.fullCardsNumber,this.nextOffset=t.nextOffset,this.confirmAllHash=t.confirmAllHash,this.declineAllHash=t.declineAllHash,this.submitAllLimit=t.submitAllLimit;var r=this.block.querySelector(".PhotoTagBlock__cards");if(!r)throw new Error("PhotoTagBlock: incorrect data");this.cardsBlock=r,this.loadMoreBtn=this.block.querySelector(".PhotoTagBlock__loadMoreBtn"),this.confirmAllBtn=document.querySelector(".PhotoTagBlock__confirmAll"),this.declineAllBtn=document.querySelector(".PhotoTagBlock__declineAll"),this.cards=this.createCards(this.getAllTagElements(this.cardsBlock)),this.initListeners()}return e.prototype.initListeners=function(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.addEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.addEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.addEventListener("click",this.loadMore),document.addEventListener(x.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.addEventListener(x.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.addEventListener(x.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.addEventListener(x.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.addEventListener(x.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.nextOffset&&this.isFullPage&&window.addEventListener("scroll",this.checkScroll)},e.prototype.deInitListeners=function(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.removeEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.removeEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.removeEventListener("click",this.loadMore),document.removeEventListener(x.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.removeEventListener(x.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.removeEventListener(x.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.removeEventListener(x.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.removeEventListener(x.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.isFullPage&&this.nextOffset&&document.removeEventListener("scroll",this.checkScroll)},e.prototype.onSubmitAll=function(e,t){var o=(0,c.curBox)();o&&o.hide(),(0,b.decrementLeftMenuPhotoCounter)(e);var r="";r=!this.submitAllLimit||this.fullCardsNumber<=this.submitAllLimit?"/albums"+window.vk.id:"/albums"+window.vk.id+"?act=recognition_tags",this.go(r,t)},e.prototype.go=function(e,t){void 0===t&&(t="");var o=document.querySelector("#box_layer_wrap"),r=document.querySelector("#box_loader");window.nav.go(e,null,{onDone:function(){t&&(0,c.showDoneBox)(t)},showProgress:function(){(0,i.show)(o),(0,i.show)(r),(0,c.boxRefreshCoords)(r)},hideProgress:function(){(0,i.hide)(o),(0,i.hide)(r)}})},e.prototype.getActiveCardsNumber=function(){var e=this.cards.filter((function(e){return e.isActive()})).length,t=this.cards.length-e;return this.fullCardsNumber-t},e.prototype.destroy=function(){this.isDestroyed=!0,this.deInitListeners(),this.cards.forEach((function(e){return e.destroy()}))},e.prototype.createCards=function(e){return e.map((function(e){return D.isPhotoSuggestedTagCard(e)?new k(e):new B(e)}))},e}(),M=o(59121);!function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(S||(S={}));var F=function(e,t,o,r){return new Promise((function(i,n){var a=new XMLHttpRequest;a.open("POST",e,!0),a.upload.onloadstart=function(e){o.totalBytes+=e.total,r()},a.upload.onprogress=function(e){e.lengthComputable&&(o.loadedBytes=e.loaded,o.totalBytes=e.total),r()},a.onerror=function(){n("Unknown error")},a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){if(JSON.parse(a.responseText).error_code)return void n(a.responseText);i(a.responseText)}};var s=function(e){return Array.from(e.entries()).reduce((function(e,t){var o=(0,f.__read)(t,2)[1];return e+("string"==typeof o?o.length:o.size)}),0)}(t);o.totalBytes=s,a.send(t)}))},H=function(){function e(e){var t,o,r,n=this;this.uploadUrl="",this.uploadedFiles=[],this.uploadMode=S.queue,this.uploadRequests=[],this.uploaderTasksQueue=[],this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=function(e){var t;if(e.preventDefault(),e.stopPropagation(),n.dragOverClass&&((0,i.hide)(n.dropArea),null===(t=n.dropArea)||void 0===t||t.classList.remove(n.dragOverClass)),n.isDndActive=!1,e.dataTransfer){var o=n.getAcceptedFilesOnly(e.dataTransfer.files);n.manualUploadFiles(o)}},this.handleInputChange=function(e){var t=e.target.files;if(t&&0!==t.length){var o=n.getAcceptedFilesOnly(t);n.manualUploadFiles(o)}},this.handleDragOver=function(e){e.preventDefault(),e.stopPropagation(),window.setTimeout((function(){window.clearTimeout(n.dndTimer),n.dndTimer=-1}),0)},this.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation(),-1!==n.dndTimer&&window.clearTimeout(n.dndTimer),n.dndTimer=window.setTimeout((function(){var e;n.isDndActive=!1,n.dragOverClass&&((0,i.hide)(n.dropArea),null===(e=n.dropArea)||void 0===e||e.classList.remove(n.dragOverClass))}),100)},this.handleDragEnter=function(e){var t;e.preventDefault(),e.stopPropagation(),n.isDndActive||(window.setTimeout((function(){window.clearTimeout(n.dndTimer),n.dndTimer=-1}),0),n.isDndActive=!0,n.dragOverClass&&(null===(t=n.dropArea)||void 0===t||t.classList.add(n.dragOverClass),(0,i.show)(n.dropArea)))},this.accept=null!==(t=e.accept)&&void 0!==t?t:["image/*"],this.multiple=null!==(o=e.multiple)&&void 0!==o&&o,this.dragOverClass=e.dragOverClass,this.uploadUrl=e.uploadUrl,this.uploadMode=null!==(r=e.uploadMode)&&void 0!==r?r:S.queue,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.dropArea&&this.initDropArea(e.dropArea)}return e.prototype.cancelUpload=function(e){e.cancelled=!0},e.prototype.cancelAllUploads=function(){var e=this;this.uploadedFiles.forEach((function(t){e.cancelUpload(t)}))},e.prototype.nextBatch=function(){var e=this.uploaderTasksQueue.shift();e&&e()},e.prototype.sendFilesUploadEvent=function(e,t){var o=this.uploadedFiles,r=this.uploadRequests.reduce((function(e,t){return e+t.loadedBytes}),0),i=this.uploadRequests.reduce((function(e,t){return e+t.totalBytes}),0);o.forEach((function(n){n.cancelled||(Object.assign(n,{loadedSize:r,totalCount:o.length,totalSize:i}),e(n,t))}))},e.prototype.startFilesUpload=function(e,t){var o=this;this.uploadedFiles=t.map((function(e,o){return{file:e,fileName:e.name,ind:0,loadedSize:0,num:o,totalCount:t.length,totalSize:e.size,uploaded:!1,error:void 0,cancelled:!1}})),this.onLoadStart&&this.sendFilesUploadEvent(this.onLoadStart);for(var r=(0,f.__spreadArray)([],(0,f.__read)(this.uploadedFiles),!1),i=[],n=function(){for(var t=[],n=0,a=0;a<5&&0!==r.length;a++){var s=r.shift();if(!s)break;if(n+=s.file.size,t.push(s),n>5242880)break}t.length&&i.push((function(){return o.sendUploadRequest(e,t)}))};r.length;)n();var a=[];return this.uploadMode===S.parallel?i.forEach((function(e){a.push(e())})):(i.forEach((function(e){a.push(new Promise((function(t){o.uploaderTasksQueue.push((function(){return e().then((function(e){return t(e),e}))}))})))})),this.nextBatch()),Promise.all(a)},e.prototype.sendUploadRequest=function(e,t){var o=this,r=new FormData,i={loadedBytes:0,totalBytes:0};this.uploadRequests.push(i);for(var n=0;n<t.length;n++){var a=t[n];r.append("file"+(n+1),a.file)}return F(e,r,i,(function(){o.onProgress&&o.sendFilesUploadEvent(o.onProgress)})).then((function(e){var r;t.forEach((function(e){e.uploaded=!0}));try{r=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return Object.values(r.files).forEach((function(e,i){e&&(o.saveUploaderStateToFileState(t[i],e),Object.assign(t[i],{server:r.server,userId:r.user_id}),i++)})),o.onLoadEnd&&t.length&&o.onLoadEnd(t,[r]),e})).catch((function(e){return t.forEach((function(t){t.errorMessage=e})),e}))},e.prototype.initFileInput=function(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")},e.prototype.initDropArea=function(e){var t,o,r;this.dropArea=e,null===(t=this.dropArea)||void 0===t||t.addEventListener("dragleave",this.handleDragLeave),null===(o=this.dropArea)||void 0===o||o.addEventListener("dragover",this.handleDragOver),null===(r=this.dropArea)||void 0===r||r.addEventListener("drop",this.handleDrop)},e.prototype.destroy=function(){var e,t,o;null===(e=this.dropArea)||void 0===e||e.removeEventListener("dragleave",this.handleDragLeave),null===(t=this.dropArea)||void 0===t||t.removeEventListener("dragover",this.handleDragOver),null===(o=this.dropArea)||void 0===o||o.removeEventListener("drop",this.handleDrop)},e.prototype.getAcceptedFilesOnly=function(e){var t=this;return(0,f.__spreadArray)([],(0,f.__read)(e),!1).filter((function(e){return function(e,t){if(e&&t){var o=e.name||"",r=(e.type||"").toLowerCase(),i=r.replace(/\/.*$/,"");return t.some((function(e){var t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):r===t}))}return!0}(e,t.accept)}))},e.prototype.cleanupFields=function(){this.input&&(this.input.value=""),this.uploadRequests=[]},e.prototype.handleError=function(e){var t,o,r=0,i="unknown error";if("string"==typeof e)try{var n=JSON.parse(e);r=null!==(t=n.error_code)&&void 0!==t?t:r,i=null!==(o=n.error_msg)&&void 0!==o?o:i}catch(t){i=e}else i=e.message;this.onError&&this.onError(this.uploadedFiles,r,i)},e.prototype.uploadFiles=function(e){return this.startFilesUpload(this.uploadUrl,e).then((function(e){return Promise.all(e.map((function(e){var t;try{t=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return t})))}))},e.prototype.saveUploaderStateToFileState=function(e,t){t&&(t.error_code?Object.assign(e,{errorCode:t.error_code,errorMessage:t.error_msg}):Object.assign(e,{width:+t.meta.width,height:+t.meta.height,kid:t.meta.kid,secret:t.secret,sha:t.sha}))},e.prototype.manualUploadFiles=function(e){var t=this;e.length?this.uploadFiles(e).then((function(e){var o=t.uploadedFiles.filter((function(e){return!e.cancelled}));t.onLoadEndAll&&o.length&&t.onLoadEndAll(t.uploadedFiles,e)})).finally((function(){t.cleanupFields()})).catch((function(e){t.handleError(e)})):this.cleanupFields()},e}(),N=new Map,R=function(e){return N.get(e)},G=function(e,t){if(N.has(e)){var o=N.get(e);o&&o.destroy()}var r=new H(t);return N.set(e,r),r},j=o(93680),z=o(8069),q=o(65641),V=o(79957);function Y(e){return e.fileName.replace(/[&<>"']/g,"")}var W={Upload:function(){function e(e){this.id=e.id,this.uploadUrl=e.uploadUrl,this.userId=e.userId,this.albumId=e.albumId,e.groupId&&(this.groupId=e.groupId),e.options&&(this.maxFiles=e.options.max_files||10,this.isWiki=!!e.options.wiki_editor,this.bugCommentEditor=e.options.bugcomments_editor||""),this.init()}return e.prototype.beforeUpload=function(e){var t=window.cur,o=this.maxFiles-(t.savedPhotos||[]).length-(t.attachCount&&t.attachCount()||0);if(o<=0)return Promise.reject((0,C.getLang)("global_error"));if(e.length<=o)return Promise.resolve(e);var r=(0,C.getLang)("global_attach_max_n_files",this.maxFiles).replace("{count}",this.maxFiles);return new Promise((function(t,i){var n={title:(0,C.getLang)("global_error"),width:430,dark:1,bodyStyle:"padding: 20px; line-height: 160%;"};(0,_.showFastBox)(n,r,(0,C.getLang)("global_continue"),(function(){(0,c.curBox)().hide(),t(e.slice(0,o))}),(0,C.getLang)("global_cancel"),(function(){(0,c.curBox)().hide(),i("Abort by user")}))}))},e.prototype.removeProgress=function(e){this.isWiki||Object.keys(e.files).forEach((function(t){var o,r,i=e.files[t],n=i.ind+"_"+Y(i);if(window.__upload_callback&&delete window.__upload_callback[n],window.cur.imMedia){null===(o=document.getElementById("upload"+n+"_progress_wrap"))||void 0===o||o.remove();var a=window.cur.imMedia.lnkId;window.cur.addMedia[a].unchooseMedia(!1)}else if(window.cur.addMedia){null===(r=document.getElementById("upload"+n+"_progress_wrap"))||void 0===r||r.remove(),(a=(window.cur.attachMediaIndexes||{})[n])&&window.cur.addMedia[a].unchooseMedia(!1)}}))},e.prototype.choosePhotoUploadFailed=function(e){this.removeProgress(e),this.isWiki||(0,V.statlogsValueEvent)("upload_photo_fails",e.files.length,e.response.server,e.response.error_code),"errorCode"in e&&e.errorCode&&(0,c.showDoneBox)((0,C.getLang)("photos_add_error")+" ("+e.errorCode+")"),window.cur.onMediaUploadFail&&window.cur.onMediaUploadFail(),this.instance.nextBatch()},e.prototype.choosePhotoUploaded=function(e){var t=this,o=Object.keys(e.files).some((function(t){var o=e.files[t],r=o.ind+"_"+Y(o),n=document.getElementById("upload"+r+"_progress_wrap");if(n){var a=(0,i.gpeByClass)("submit_post_box",n);return!!a&&a.classList.contains("reply_box")}return!1}),{}),r=Object.values(e.files);j.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId||0,aid:this.albumId,is_reply:o?1:0,upload_v2:1,bugcomments_editor:this.bugCommentEditor,photos:e.responseString},{onDone:function(e){window.cur.preventBoxHideWithSharedBox=!0,Object.entries(e).forEach((function(e,t){var o=(0,f.__read)(e,2),i=o[0],n=o[1],a=r[t];window.cur.chooseMedia("photo",i,Object.assign({upload_ind:a.ind+"_"+a.fileName},n))})),window.cur.preventBoxHideWithSharedBox=!1,t.instance.nextBatch()},onFail:this.choosePhotoUploadFailed.bind(this,e)})},e.prototype.alWysiwygChoosePhotoUploaded=function(e){var t,o=this;j.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId,aid:this.albumId,al_wiki_editor:1,upload_v2:1,photos:e.responseString},{onDone:function(e,t,r,i){window.editorChoosePhoto&&window.editorChoosePhoto(e,t,r,i),o.instance.nextBatch()},onFail:this.choosePhotoUploadFailed.bind(this,e),progress:null===(t=(0,c.curBox)())||void 0===t?void 0:t.progress})},e.prototype.uploadProgress=function(e){var t=this;if(e.cancelled)return!0;this.isWiki||Object.keys(e.files).forEach((function(o){var r=e.files[o],i=r.ind,n=Y(r),a=i+"_"+n,s=(window.cur.attachMediaIndexes||{})[a];if(void 0===s||s&&window.cur.addMedia[s]||window.cur.imMedia){var l={loaded:r.loadedSize,total:r.fileSize,name:n};window.__upload_callback||(window.__upload_callback={}),window.__upload_callback[a]=function(){t.instance.cancelUpload(e),t.removeProgress(e)},window.cur.showMediaProgress("photo",i,l,!0)}}))},e.prototype.uploadStart=function(e){if(this.isWiki){var t=document.getElementById("photos_choose_upload_area_"+this.id);t&&(t.innerHTML='<img src="/images/upload.gif"/>',t.removeAttribute("onclick"))}else{var o=(0,c.curBox)();o&&o.needHideLastCheck?window.boxQueue.hideLast(o.preventHideLastWithCheck):window.boxQueue.hideLast(),this.uploadProgress(e),window.cur.onMediaUploadStarted&&window.cur.onMediaUploadStarted()}window.cur.setChooseUploadFlag&&window.cur.setChooseUploadFlag("start")},e.prototype.uploadComplete=function(e){e.cancelled?this.removeProgress(e):"error_code"in e.response&&e.response.error_code?this.choosePhotoUploadFailed(e):((0,V.statlogsValueEvent)("upload_photo_fails",e.response.files.length,e.response.server,"success"),this.isWiki?this.alWysiwygChoosePhotoUploaded(e):this.choosePhotoUploaded(e))},e.prototype.uploadCompleteAll=function(){window.cur.setChooseUploadFlag&&window.cur.setChooseUploadFlag("finish"),window.cur.choosePhotoUploadedAll&&window.cur.choosePhotoUploadedAll()},e.prototype.onDragEnter=function(){var e=document.getElementById("photos_choose_upload_area_wrap");if(e&&!e.classList.contains("photos_choose_upload_area_enter")){(0,i.hide)("photos_choose_wrap"),(0,i.hide)("photos_choose_more");var t=document.querySelector("#photos_choose_wrap"),o=(0,i.getXY)(t)[1],r=(0,i.getSize)(e)[1];e.style.height=(0,p.scrollGetY)()+document.documentElement.clientHeight-o+r+"px",e.classList.add("photos_choose_upload_area_enter"),this.dropArea.style.overflow="hidden"}},e.prototype.onDragLeave=function(){var e=document.querySelector("#photos_choose_upload_area_wrap");e&&(e.classList.remove("photos_choose_upload_area_enter"),e.style.height="",(0,i.show)("photos_choose_wrap"),(0,i.show)("photos_choose_more"),this.dropArea.style.overflow="")},e.prototype.init=function(){var e=this;this.dropArea=document.getElementById("box_layer_wrap"),this.instance=z.GoUploaderHelper.init(this.id,{uploadUrl:this.uploadUrl,input:document.getElementById("photos_upload_input_"+this.albumId),multiple:!0,multipleMaxSize:1,dropArea:this.dropArea,uploadMode:q.UploadMode.queue,onDragEnter:this.onDragEnter.bind(this),onDragLeave:this.onDragLeave.bind(this),onBeforeUpload:this.beforeUpload.bind(this),onLoadStart:this.uploadStart.bind(this),onProgress:this.uploadProgress.bind(this),onLoadEnd:this.uploadComplete.bind(this),onLoadEndAll:this.uploadCompleteAll.bind(this),onError:this.choosePhotoUploadFailed.bind(this)}),window.cur.initChooseUploadFlags={},window.cur.setChooseUploadFlag=function(t){var o,r;window.cur.initChooseUploadFlags&&(t&&(window.cur.initChooseUploadFlags[t]=!0),"finish"===t&&delete window.cur.initChooseUploadFlags[t],!window.cur.initChooseUploadFlags.clean_box||(null===(o=window.cur)||void 0===o?void 0:o.initChooseUploadFlags.start)&&!(null===(r=window.cur)||void 0===r?void 0:r.initChooseUploadFlags.finish)||e.instance.destroy())},window.cur.nav.push((function(){return e.instance.cancelAllUploads(),e.instance.destroy(),!0}))},e}()},$=o(33321),X={LOAD_TYPE_PHOTOS:"photos",LOAD_TYPE_ALBUMS:"albums",LOAD_TYPE_TAGGED:"tagged",MAX_DESC_INPUT_HEIGHT:600,changeAlbumPhoto(e){(0,_.showBox)("al_photos.php",{act:"change_thumb_box",album:e})},onMouseOverEditRow(e){var t=(0,i.geByClass1)("photos_photo_edit_row_desc_placeholder",e),o=(0,i.geByClass1)("photos_photo_edit_row_desc_input",e);(0,i.setTitle)(t,!1,(0,i.val)(o))},editInitSorter(){var e=(0,i.ge)("photos_container_photos");cur.photosEditSorter=new GridSorter(e,"photos_photo_edit_row_thumb",{onReorder:X.reorderPhotos})},updateEditHeaderPos(){void 0===cur.photosEditHeaderEl&&(cur.photosEditHeaderEl=(0,i.geByClass1)("photos_edit_selection_header")),cur.photosEditHeaderEl&&(cur.photosEditHeaderElOffset=cur.photosEditHeaderElOffset||(0,i.getXY)(cur.photosEditHeaderEl)[1]-(0,i.getSize)((0,i.ge)("page_header_cont"))[1],(0,p.scrollGetY)()>=cur.photosEditHeaderElOffset?(0,i.hasClass)(cur.photosEditHeaderEl,"photos_header_fixed")||((0,i.addClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,i.setStyle)(cur.photosEditHeaderEl,{width:(0,i.getSize)((0,i.ge)("page_body"))[0]}),(0,i.setStyle)((0,i.domNS)(cur.photosEditHeaderEl),{"margin-top":(0,i.getSize)(cur.photosEditHeaderEl)[1]+"px"})):((0,i.removeClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,i.setStyle)(cur.photosEditHeaderEl,{width:""}),(0,i.setStyle)((0,i.domNS)(cur.photosEditHeaderEl),{"margin-top":0})))},_editGetSelectedCount(){var e=(0,i.geByClass)("photos_edit_selected").length;if(cur.photoEditSelectedAll){var t=(0,i.geByClass)("photos_photo_edit_row").length;e=e<t?cur.count-t+e:cur.count}return e},editSelectAll(e){cur.photoEditSelectedAll=!e,(0,h.each)((0,i.geByClass)("photos_photo_edit_row"),(function(){(0,i.toggleClass)(this,"photos_edit_selected",cur.photoEditSelectedAll)})),X._editUpdateSelectedCounter()},_editUpdateSelectedCounter(){var e,t=X._editGetSelectedCount();e=t?(0,C.getLang)("photos_edit_selected_count").replace("{total}",cur.count).replace("{count}",t):(0,C.langNumeric)(cur.count,cur.lang.photos_edit_selected_count_initial,!0),(0,i.val)((0,i.ge)("photos_edit_selected_label"),e);var o=(0,i.ge)("photos_edit_selected_actions");(0,i.toggleClass)(o,"photos_selected",!!t),(0,i.geByClass)("photos_edit_selected_action",o).forEach((function(e){(0,i.toggleClass)(e,"link_lock",!t)}));var r=(0,i.ge)("photos_select_all_toggle");cur.photosEditSelectedHalf=t>=cur.count/2,cur.photosEditSelectedHalf?(0,i.val)(r,(0,C.getLang)("photos_edit_deselect_all")):(0,i.val)(r,(0,C.getLang)("photos_edit_select_all"))},selectEditPhoto(e,t){var o=(0,i.gpeByClass)("photos_photo_edit_row",t),r=(0,i.toggleClass)(o,"photos_edit_selected");if(e.shiftKey&&cur.photoEditPrevSelectedRowEl&&cur.photoEditPrevSelectedRowEl!=o)for(var n=(0,i.gpeByClass)("photos_edit_photos_container",t),a=(0,i.domFC)(n),s=0;s<2&&a;)a!=cur.photoEditPrevSelectedRowEl&&a!=o||s++,s&&(0,i.toggleClass)(a,"photos_edit_selected",r),a=(0,i.domNS)(a);return cur.photoEditPrevSelectedRowEl=o,X._editUpdateSelectedCounter(),(0,u.cancelEvent)(e),!1},startEditPhotoDescription(e,t){X.stopEditPhotoDescription();var o=(0,i.gpeByClass)("photos_edit_photos_container",t),r=(0,i.hasClass)(t,"photos_photo_edit_row")?t:(0,i.gpeByClass)("photos_photo_edit_row",t),a=(0,i.geByClass1)("photos_photo_edit_row_desc_cont",r),s=(0,i.geByClass1)("photos_photo_edit_row_desc_placeholder",r),l=(0,i.geByClass1)("photos_photo_edit_row_desc_input",r);function d(e,t,o,r){var a=(0,h.clean)((0,i.val)(o)).split("\n").join("<br>")+"&nbsp;",s=(0,i.ce)("div",{innerHTML:a,className:"photos_photo_edit_row_desc_input"},{width:(0,i.getSize)(t)[0],display:"block",visibility:"hidden"});e.appendChild(s);var l=(0,i.getSize)(s)[1]+(n.browser.msie?10:0);(0,i.setStyle)(o,{height:Math.min(X.MAX_DESC_INPUT_HEIGHT,Math.round(l))}),(0,i.re)(s)}(0,i.val)(l,l.getAttribute("data-orig-desc")),d(a,s,l),(0,i.show)(l),(0,u.addEvent)(document,"click",X.stopEditPhotoDescription),(0,u.removeEvent)(l,"input"),(0,u.addEvent)(l,"input",d.pbind(a,s,l)),l.select(),(0,i.addClass)(o,"photos_desc_editing"),(0,i.addClass)(r,"photos_row_desc_editing"),e&&(0,u.cancelEvent)(e)},onEditPhotoDescriptionKeyPress(e){switch(e.keyCode){case 27:X.stopEditPhotoDescription(null,!0);break;case 9:X.stopEditPhotoDescription(null,!1);var t=(0,i.gpeByClass)("photos_photo_edit_row",e.currentTarget);(t=(0,i.domNS)(t))&&X.startEditPhotoDescription(null,t),(0,u.cancelEvent)(e)}},stopEditPhotoDescription(e,t){var o;e&&(0,i.hasClass)(e.target,"photos_photo_edit_row_desc_input")||((0,u.removeEvent)(document,"click",X.stopEditPhotoDescription),(0,h.each)((0,i.geByClass)("photos_row_desc_editing"),(function(){o=this,(0,i.removeClass)(o,"photos_row_desc_editing");var e=(0,i.geByClass1)("photos_photo_edit_row_desc_placeholder",o),r=(0,i.geByClass1)("photos_photo_edit_row_desc_input",o),n=o.getAttribute("data-id"),a=o.getAttribute("data-edit-hash"),s="";t?s=r.getAttribute("data-orig-desc"):((s=(0,h.trim)((0,i.val)(r)))!=r.getAttribute("data-orig-desc")&&ajax.post("al_photos.php",{act:"save_desc",photo:n,hash:a,text:s,edit:1},{}),r.setAttribute("data-orig-desc",s),e.titleSet=!1);(0,i.val)(e,(0,h.clean)(s)||(0,C.getLang)("photos_add_description_placeholder")),(0,i.toggleClass)(e,"photos_edit_has_desc",!!s),(0,i.hide)(r)})),(0,i.removeClass)((0,i.gpeByClass)("photos_edit_photos_container",o),"photos_desc_editing"))},updatePeriods(){cur.periods=(0,i.geByClass)("photos_period_delimiter",(0,i.ge)("photos_all_block"))},destroyPeriod(){cur.fixedPeriod&&((0,i.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)},fixPeriod(){if((0,i.ge)("photos_albums_block")&&(X.headerHeight=X.headerHeight||(0,i.getSize)((0,i.ge)("page_header_cont"))[1],cur.periods&&cur.periods.length)){var e=vk.staticheader?Math.max((0,p.scrollGetY)(),X.headerHeight):(0,p.scrollGetY)()+X.headerHeight,t=!1,o=!1,r=(0,i.getSize)(cur.periods[0])[1];for(var n in cur.periods)if(cur.periods.hasOwnProperty(n)){if((0,i.getXY)(cur.periods[n])[1]>=e)break;t=cur.periods[n];var a=(0,h.intval)(n)+1;o=!!cur.periods[a]&&(0,i.getXY)(cur.periods[a])[1]-e}if(t&&!cur.fileApiUploadStarted){if(t==cur.fixedPeriodEl)setTimeout((function(){(0,i.setStyle)(cur.fixedPeriod,{left:(0,i.getXY)(t)[0]+"px"})}));else{if(cur.fixedPeriod)cur.fixedPeriod.innerHTML=t.innerHTML;else{var s=cur.fixedPeriod=(0,i.ce)("div",{innerHTML:t.innerHTML,className:"photos_period_delimiter_fixed"},{left:(0,i.getXY)(t)[0]+"px"});(0,i.ge)("page_body").appendChild(cur.fixedPeriod),(cur._back?cur._back.hide:cur.destroy).push((function(){(0,i.re)(s)}))}cur.fixedPeriodEl=t}var l=!1!==o?o-r:0;l>=0&&(l=0),cur.fixedPeriodTop!==l&&((0,i.setStyle)(cur.fixedPeriod,{top:l+"px"}),cur.fixedPeriodTop=l)}else!t&&cur.fixedPeriod&&((0,i.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)}},scrollResize(){if(!n.browser.mobile&&!cur.pvShown){var e=document.documentElement,t=window.innerHeight||e.clientHeight||bodyNode.clientHeight,o=(0,p.scrollGetY)(),r=(0,i.ge)("ui_photos_load_more"),a=(0,i.ge)("ui_albums_load_more"),s=(0,i.ge)("ui_tagged_load_more"),l=.8*t;(0,i.isVisible)(r)&&r.offsetTop-(o+t)<l&&X.load(),(0,i.isVisible)(a)&&cur.showAllAlbums&&a.offsetTop-(o+t)<l&&X.load(X.LOAD_TYPE_ALBUMS),(0,i.isVisible)(s)&&cur.showAllTagged&&s.offsetTop-(o+t)<l&&X.load(X.LOAD_TYPE_TAGGED),cur.fixPeriods&&X.fixPeriod(),X.updateEditHeaderPos()}},initScroll(){cur.module="photos",X.scrollnode=n.browser.msie6?pageNode:window,(0,u.addEvent)(X.scrollnode,"scroll",X.scrollResize),(0,u.addEvent)(window,"resize",X.scrollResize),(0,u.removeEvent)(window,"load",X.initScroll),cur.destroy.push((function(){(0,u.removeEvent)(X.scrollnode,"scroll",X.scrollResize),(0,u.removeEvent)(window,"resize",X.scrollResize)}))},recache(e,t){if(cur.loading)return cur.loading=1,void setTimeout(X.recache.pbind(e,t),100);for(var o=cur.offset;ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];o+=20){var r=ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];r[0]+=t,ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+(o+t)+"&part=1"]=r,delete ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"]}cur.offset+=t},loaded(e,t,o,r){var n,a,s,l,d,c;switch(r||(cur.loading=0),r=r||X.LOAD_TYPE_PHOTOS){case X.LOAD_TYPE_TAGGED:cur.taggedOffset=e,s=cur.moreFromTagged,d=cur.moreTaggedOpts,l=cur.taggedOffset;break;case X.LOAD_TYPE_ALBUMS:cur.albumsOffset=e,s=cur.moreFromAlbums,d=cur.moreAlbumsOpts,l=cur.albumsOffset,c=cur.albumsCount;break;default:cur.offset=e,s=cur.moreFrom,d=cur.moreOpts,l=cur.offset,c=cur.count}n=(0,i.ge)("photos_container_"+r),a=(0,i.ge)("ui_"+r+"_load_more");for(var u=(0,i.ce)("div",{innerHTML:(0,h.trim)(t)});u.firstChild;){if((0,i.hasClass)(u.firstChild,"photos_period_delimiter")){var p=u.firstChild.getAttribute("data-year");if((0,i.geByClass1)("photos_period_delimiter_"+p)){(0,i.re)(u.firstChild);continue}}cur.photoEditSelectedAll&&(0,i.addClass)(u.firstChild,"photos_edit_selected"),n.appendChild(u.firstChild)}o&&(0,h.extend)(cur.privacy,o),r==X.LOAD_TYPE_PHOTOS&&X.updatePeriods(),e>=c||!t?(0,i.hide)(a):r!=X.LOAD_TYPE_PHOTOS&&(cur.loading=1,ajax.post(s,(0,h.extend)({offset:l,part:1},d||{}),{cache:1,onDone:function(){2==cur.loading?X.loaded.apply(window,arguments):cur.loading=!1},onFail:function(){return cur.loading=0,!0}}))},load(e){var t,o,r,n;switch(e=e||X.LOAD_TYPE_PHOTOS){case X.LOAD_TYPE_PHOTOS:t=(0,i.ge)("ui_photos_load_more"),o=cur.moreFrom,r=cur.moreOpts,n=cur.offset;break;case X.LOAD_TYPE_TAGGED:t=(0,i.ge)("ui_tagged_load_more"),o=cur.moreFromTagged,r=cur.moreTaggedOpts,n=cur.taggedOffset;break;case X.LOAD_TYPE_ALBUMS:t=(0,i.ge)("ui_albums_load_more"),o=cur.moreFromAlbums,r=cur.moreAlbumsOpts,n=cur.albumsOffset}o&&(0,i.isVisible)(t)&&!(0,g.isButtonLocked)(t)&&(cur.loading?cur.loading=2:(e==X.LOAD_TYPE_PHOTOS&&r&&(cur.loading=1),ajax.post(o,(0,h.extend)({offset:n,part:1},r||{}),{onDone:X.loaded,onFail:function(){return cur.loading=0,!0},showProgress:function(){(0,g.lockButton)(t)},hideProgress:function(){(0,g.unlockButton)(t)},cache:1})))},loadMoreButtonClick(e){switch(e){case X.LOAD_TYPE_ALBUMS:cur.showAllAlbums=!0;break;case X.LOAD_TYPE_TAGGED:cur.showAllTagged=!0}this.load(e)},reorderAlbums(e,t,o){var r=e.id.replace("album",""),i=(t&&t.id||"").replace("album",""),n=(o&&o.id||"").replace("album","");ajax.post("al_photos.php",{act:"reorder_albums",album:r,before:i,after:n,hash:cur.reorderHash})},reorderPhotos(e,t,o){var r="edit"==nav.objLoc.act?"photo_edit_row_":"photo_row_",n=e.id.replace(r,""),a=(t&&t.id||"").replace(r,""),s=(o&&o.id||"").replace(r,""),l=(0,i.domData)((0,i.ge)("photos_container_photos"),"rev");l=l?"1"===l?1:"":nav.objLoc.rev,ajax.post("al_photos.php",{act:"reorder_photos",photo:n,before:a,after:s,rev:l,hash:cur.reorderHash})},privacy(e){if("photos_move"==e){var t=Privacy.getValue(e);return(t=(t=t.split("_"))[2])!=cur.album.split("_")[1]&&X.movePhoto(t),!0}var o=e.match(/^album(\d+)/);if(o){var r=(0,i.ge)("album"+vk.id+"_"+o[1]);if(r){if(r.helper){var n=(0,i.getSize)(r);if(n[0]!=r.w||n[1]!=r.h){(0,i.setStyle)(r.helper,{width:n[0],height:n[1]-(0,i.ge)("photos_container").sorter.dh}),(0,h.extend)(r,{x:r.x-r.w/2+n[0]/2,w:n[0],y:r.y-r.h/2+n[1]/2,h:n[1]});for(var a=r.nextSibling;a&&a.nextSibling;a=a.nextSibling.nextSibling)(0,i.setStyle)(a.nextSibling,{left:a.offsetLeft,top:a.offsetTop})}}clearTimeout(cur["privacy_timer_"+e]),cur["privacy_timer_"+e]=setTimeout(ajax.post.pbind("al_friends.php",{act:"save_privacy",key:e,val:Privacy.getValue(e),hash:cur.privacyHash}),500)}}},deleteAlbum(e,t){(0,_.showFastBox)({title:(0,C.getLang)("photos_deleting_album"),dark:1,bodyStyle:"padding: 20px;"},(0,C.getLang)("photos_sure_del_album"),(0,C.getLang)("global_delete"),(function(o){ajax.post("al_photos.php",{act:"delete_album",album:e,hash:t},{showProgress:()=>(0,g.lockButton)(o),hideProgress:()=>(0,g.unlockButton)(o)})}),(0,C.getLang)("global_cancel"))},showSaved(e,t){var o=(0,i.ge)(e),r=function(){setTimeout(s.animate.pbind(o,{backgroundColor:t,borderLeftColor:"#D8DFEA",borderRightColor:"#D8DFEA",borderTopColor:"#D8DFEA",borderBottomColor:"#D8DFEA"},1e3),1e3)};(0,i.isVisible)(o)?(0,s.animate)(o,{backgroundColor:"#E7F1F9",borderLeftColor:"#4C96D4",borderRightColor:"#4C96D4",borderTopColor:"#4C96D4",borderBottomColor:"#4C96D4"},200,r):((0,i.show)(o),r())},saveAlbum(e){var t={act:"save_album",album:cur.album,hash:cur.albumhash,title:(0,i.ge)("album_title").value,desc:(0,i.ge)("album_description").value,enable_hintach:(0,g.isChecked)("hintach_enabled_for_album")};if(!t.title)return(0,g.notaBene)("album_title");var o=cur.album.replace(vk.id+"_","");cur.privacy["album"+o]?(0,h.extend)(t,{view:Privacy.getValue("album"+o),comm:Privacy.getValue("albumcomm"+o)}):(0,i.ge)("album_only_check")&&(0,h.extend)(t,{main:(0,g.isChecked)("album_main_check"),only:(0,g.isChecked)("album_only_check"),comm:(0,g.isChecked)("album_comments_check")}),ajax.post("al_photos.php",t,{onDone:function(){var e=(0,i.ge)("album_main_check");e&&(0,g.isChecked)(e)&&((0,i.addClass)(e,"on"),(0,i.addClass)(e,"disabled"),(0,i.hide)("album_delete_action"));var t=(0,i.ge)("photos_changes_saved");(0,i.setStyle)(t,{opacity:1}),setTimeout((function(){(0,i.setStyle)(t,{opacity:0})}),1500)},showProgress:()=>(0,g.lockButton)(e),hideProgress:()=>(0,g.unlockButton)(e)})},savePhotos(){for(var e={act:"save_photos",album:cur.album,hash:cur.albumhash},t=(0,i.ge)("photos_container"),o=0,r=t.firstChild;r;r=r.nextSibling)if(r.firstChild&&(0,i.isVisible)(r.firstChild)){var n=r.id.replace("photo_edit_row","");e["photo_id"+o]=n,e["photo_desc"+o]=(0,i.ge)("photo_caption"+n).value,++o}ajax.post("al_photos.php",e,{onDone:function(){for(var e=t.firstChild;e;e=e.nextSibling)if(e.firstChild&&(0,i.isVisible)(e.firstChild)){var o=e.id.replace("photo_edit_row","");(0,i.ge)("photo_save_result"+o).innerHTML=(0,C.getLang)("photos_privacy_description")}cur.descs=!1,(0,p.scrollToTop)(200),X.showSaved("photos_saved_msg","#F3F8FC"),(0,i.ge)("photos_container").sorter&&sorter.update((0,i.ge)("photos_container").sorter.elems[0])},progress:"photos_save_progress"})},deleteSelectedPhotos(e){var t=[];(0,h.each)((0,i.geByClass)("photos_edit_selected"),(function(){t.push(this.getAttribute("data-id"))}));var o=(0,h.intval)(X._editGetSelectedCount()>t.length),r=cur.album.split("_");(0,_.showBox)("/al_photos.php",{act:"delete_selected_box",Photo_ids:o?"":t.join(","),owner_id:r[0],album_id:r[1],all:o},{onDone(){var t=(0,c.curBox)();t.removeButtons(),t.addButton((0,C.getLang)("photos_del_selected_box_yes"),(t=>{(0,i.show)("photos_del_box_progress"),(0,i.hide)("photos_del_box_text"),(0,i.re)(t);var o=(0,i.ge)("photos_del_box_progress_text");X.doEditBatchProcess({act:"delete_photos",hash:e,owner_id:r[0],album_id:r[1]},cur.editDeletePhotosArray,(0,i.ge)("photos_del_box_progress_wrap"),"photos_del_selected_title_progress",(function(e,t,r,n,a){(0,i.val)(o,(0,C.getLang)("photos_del_selected_box_text_progress").replace("{count}",n).replace("{total}",a)),cur.count=Math.max(cur.count-e,0),(0,h.each)(r,(function(e,t){(0,i.re)("photo_edit_row_"+t),cur.count=Math.max(cur.count,0)})),X._editUpdateSelectedCounter()}),(function(){var e=(0,c.curBox)();(e&&e.hide(),0==cur.count)?nav.reload():(0,i.geByClass)("photos_photo_edit_row").length<40&&X.load()}))})),t.addButton((0,C.getLang)("box_cancel"),(function(){t.hide(),cur.editDeletePhotosArray=!1}),"no")}})},doEditBatchProcess(e,t,o,r,n,a){var s=t.split(","),l=s.length,d=cur.editPhotosMaxChunkSize||50,u=Math.ceil(l/d),p=(0,i.geByClass1)("photos_progress_bar",(0,i.ge)(o))||(0,i.geByClass1)("ui_progress_bar",(0,i.ge)(o)),g=0,_=document.title,f=(0,c.curBox)();n(0,!1,[],0,l),function t(o){if(!f.isVisible())return a(g),void(0,i.setDocumentTitle)(_);var c=s.slice(o*d,(o+1)*d);ajax.post("/al_photos.php",(0,h.extend)({photos:c.join(",")},e),{onDone:function(e,s,d){g+=e,o++,(0,i.setStyle)(p,{width:100*o/u+"%"});var h=(0,C.getLang)(r).replace("{count}",g).replace("{total}",l);(0,i.setDocumentTitle)(h),n(e,s,c,g,l,d),o<u?t(o):setTimeout((function(){(0,i.setDocumentTitle)(_),a(g,s)}),200)}})}(0)},_showProgressPanel(e){var t=(0,i.se)('<div class="photo_mask_progress _photo_mask_progress"><div class="photos_editing_background"></div><div class="round_spinner"></div></div>');return e.appendChild(t),t},_hideProgressPanel(e){(0,i.re)((0,i.geByClass1)("_photo_mask_progress",e))},deletePhoto(e,t,o,r){var n;if(""===e&&o&&(n=(0,i.gpeByClass)("photos_photo_edit_row",o),e=(0,i.attr)(n,"data-id"),t=(0,i.attr)(n,"data-edit-hash")),n=n||(0,i.ge)("photo_edit_row_"+e)){var a=X._showProgressPanel(n);return(0,i.addClass)(n,"photos_deleted"),ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:1},{onDone:function(e){(0,i.re)(a),n.appendChild((0,i.se)(e)),X.recache(cur.offset,-1),cur.count-=1,X._editUpdateSelectedCounter(),cur.count<2&&(0,i.hide)("album_thumb_action"),(0,i.ge)("photos_go_to_album_cont")&&!cur.count&&(0,i.hide)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(n),cur.introTooltipHide&&cur.introTooltipHide(!0)}}),(0,u.cancelEvent)(r)}},restorePhoto(e,t,o){var r=(0,i.ge)("photo_edit_row_"+t);if(r&&(0,i.hasClass)(r,"photos_deleted")){var n=X._showProgressPanel(r);(0,i.re)((0,i.geByClass1)("photos_restore",r)),ajax.post("al_photos.php",{act:"restore_photo",photo:t,hash:o,edit:1},{onDone:function(){(0,i.re)(n),(0,i.removeClass)(r,"photos_deleted"),X.recache(cur.offset,1),cur.count+=1,X._editUpdateSelectedCounter(),cur.count>1&&(0,i.show)("album_thumb_action"),(0,i.ge)("photos_go_to_album_cont")&&cur.count&&(0,i.show)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(r)},progress:"photo_restore_progress"+t})}},toggleMoveToAlbumMode(e,t){var o=(0,i.ge)("photos_move_box_search"),r=(0,i.ge)("pv_move_to_album_cont"),n=(0,i.ge)("photos_box_edit_data"),a=(0,c.curBox)(),s=(0,i.geByClass1)("box_title",a.titleWrap);if(e){(0,i.hide)(o),(0,i.hide)(r),(0,i.show)(n),a.setOptions({width:500});var l=(0,C.getLang)("photos_move_to_new_album_title");cur.noAlbums||(l+=`\n          <span class="divider">|</span>\n          <a onclick="return photos.toggleMoveToAlbumMode(false, event)" href="" class="toggle">\n            ${(0,C.getLang)("photos_move_to_another_album_toggle")}\n          </a>\n        `),(0,i.val)(s,l),a.removeButtons().addButton((0,C.getLang)("photos_create_album_and_move"),cur.saveNewAlbum).addButton((0,C.getLang)("global_cancel"),a.hide,"no"),cur.onNewAlbumDone=function(e){(0,c.curBox)().hide(),X.movePhotosBox(cur.editPhotosArray.split(","),!1,(function(){setTimeout((function(){var t=(0,i.ge)("album"+e);X.doMovePhotos(!1,t)}))}))}}else(0,i.show)(o),(0,i.show)(r),(0,i.hide)(n),a.setOptions({width:795}),(0,i.val)(s,(0,C.getLang)("photos_move_box_title")+'<span class="divider">|</span><a onclick="return photos.toggleMoveToAlbumMode(true, event)" href="" class="toggle">'+(0,C.getLang)("photos_move_to_new_album")+"</a>"),a.removeButtons().addButton((0,C.getLang)("global_cancel"),a.hide);return(0,u.cancelEvent)(t)},showMove(e,t,o){var r=cur.moveddc,n=(0,i.ge)("photos_move_link"+e);cur.privacyPhotoMove?Privacy.show(n,o,"photos_move"):(cur.zIndexUpdated&&(X.hideMove(),cur.noZIndexUpdate=!0),(0,i.ge)("photo_edit_row"+e)&&(cur.zIndexUpdated=e,(0,i.setStyle)((0,i.ge)("photo_edit_row"+e),{zIndex:150})),X.hideMove()),(0,h.extend)(cur,{movelnk:n,moveph:e,movehash:t}),cur.privacyPhotoMove||(n.parentNode.replaceChild(r,n),cur.movedd.focus(),cur.movedd.showDefaultList(),(0,u.addEvent)(document,"click",X.hideMove))},hideMove(){if(cur.noZIndexUpdate)delete cur.noZIndexUpdate;else if(!cur.privacyPhotoMove){if(cur.movelnk)try{cur.moveddc.parentNode.replaceChild(cur.movelnk,cur.moveddc),cur.movelnk=!1,cur.movedd.clear(),cur.zIndexUpdated&&(0,i.ge)("photo_edit_row"+cur.zIndexUpdated)&&((0,i.setStyle)((0,i.ge)("photo_edit_row"+cur.zIndexUpdated),{zIndex:100}),delete cur.zIndexUpdated)}catch(e){}(0,u.removeEvent)(document,"click",X.hideMove)}},movePhoto(e,t,o){e=(0,h.intval)(e);var r=i.show.pbind("photo_return_progress"+t),n=i.hide.pbind("photo_return_progress"+t);if(!t){if(!e||e==cur.album.split("_")[1])return X.hideMove();t=cur.moveph,o=cur.movehash,r=function(){(0,i.hide)("photo_delete_link"+t),(0,i.show)("photo_edit_progress"+t)},n=function(){(0,i.hide)("photo_edit_progress"+t),(0,i.show)("photo_delete_link"+t)}}ajax.post("al_photos.php",{act:"move_photo",album:e,photo:t,hash:o},{onDone:function(o){var r=(0,i.ge)("photo_edit_row"+t);if(r&&r.firstChild){if(e==cur.album.split("_")[1]){if((0,i.isVisible)(r.firstChild))return;r.removeChild(r.firstChild.nextSibling),(0,i.show)(r.firstChild),X.recache(cur.offset,1),++cur.count,cur.count>1&&(0,i.show)("album_thumb_action")}else{if(!(0,i.isVisible)(r.firstChild))return;X.hideMove(),(0,i.hide)(r.firstChild),r.appendChild((0,i.ce)("div",{innerHTML:o})),X.recache(cur.offset,-1),--cur.count,cur.count<2&&(0,i.hide)("album_thumb_action")}cur.photoAddUpdate&&cur.photoAddUpdate(r),cur.introTooltipHide&&cur.introTooltipHide(!0),(0,i.ge)("photos_go_to_album_cont")&&(0,i.toggle)("photos_go_to_album_cont",!!cur.count)}},onFail:function(e){if(X.hideMove(),e)return setTimeout((0,_.showFastBox)({title:(0,C.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},e).hide,2e3),!0},showProgress:r,hideProgress:n})},updateThumbs(e,t){var o=(0,i.ge)("photos_add_img"+cur.peEditPhoto);o&&(o.src=e)},editPhoto(e,t,o){cur.peEditPhoto=e,(0,_.showBox)("al_photos.php",{act:"edit_photo",photo:e,webgl:1,stat:["ui_controls.css","ui_controls.js"]},{dark:1})},backupDesc(e){cur.descs||(cur.descs={}),cur.descs[e]=(0,h.trim)((0,i.ge)("photo_caption"+e).value)},saveDesc(e,t){var o=(0,i.ge)("photo_caption"+e).value,r=cur.descs[e];delete cur.descs[e],(0,h.trim)(o)!=r&&ajax.post("al_photos.php",{act:"save_desc",photo:e,hash:t,text:o,edit:1},{onDone:function(t){(0,i.ge)("photo_save_result"+e).innerHTML=t},onFail:function(t){return(0,i.ge)("photo_save_result"+e).innerHTML='<div class="photo_save_error">'+t+"</div>",!0},showProgress:function(){(0,i.ge)("photo_save_result"+e).innerHTML=(0,C.getLang)("photos_privacy_description"),(0,i.show)("photo_save_progress"+e)},hideProgress:function(){(0,i.hide)("photo_save_progress"+e)}})},genFile:(e,t,o)=>(0,i.ce)("div",{innerHTML:`\n        <a class="photo_file_cancel" id="photo_cancel${e}" onclick="${t}">${o}</a>\n        <div class="photo_file_button">\n          <div class="file_button_gray">\n            <div class="file_button" id="photo_file_button${e}">${(0,C.getLang)("photos_choose_file")}</div>\n          </div>\n        </div>\n      `}),initFile(e){FileButton.init("photo_file_button"+e,{name:"photo",id:"photo_file"+e,accept:"image/jpeg,image/png,image/gif",onchange:X.fileSelected})},addFile(){var e=cur.files.length,t=X.genFile(e,"photos.fileCancel("+e+")",(0,C.getLang)("global_cancel"));(0,h.extend)(t,{className:"photo_upload_file",id:"photo_upload_row"+e}),(0,i.ge)("photo_upload_files").appendChild(t),X.initFile(e),cur.files.push({})},filesLoad(){for(var e=0,t=0;e<cur.files.length;++e){if((0,i.ge)("photo_file"+e).value)break}if(e!=cur.files.length){cur.allcont=utilsNode.appendChild((0,i.ce)("div",{innerHTML:`\n        <iframe name="photo_frame_all"></iframe>\n        <form target="photo_frame_all" id="photo_form_all" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var o=(0,i.ge)("photo_form_all"),r=(0,h.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"photos.filesDone",onfail:"photos.filesFail"});for(t in r)r.hasOwnProperty(t)&&o.appendChild((0,i.ce)("input",{name:t,value:r[t]}));for(e=0,t=0;e<cur.files.length;++e){var n=(0,i.ge)("photo_file"+e);n.value&&(n.name="file"+t,o.appendChild(n),++t)}o.submit()}},fileSelected(){var e=(0,h.intval)(this.id.replace("photo_file",""));if(cur.files[e].deleting||!cur.files[e].cont&&!cur.files[e].id){cur["fileDone"+e]=X.fileDone.pbind(e),cur["fileFail"+e]=X.fileFail.pbind(e),cur.files[e].cont=utilsNode.appendChild((0,i.ce)("div",{innerHTML:`\n        <iframe name="photo_frame${e}"></iframe>\n        <form target="photo_frame${e}" id="photo_form${e}" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var t=(0,i.ge)("photo_form"+e),o=(0,h.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"cur.fileDone"+e,onfail:"cur.fileFail"+e});for(var r in o)o.hasOwnProperty(r)&&t.appendChild((0,i.ce)("input",{name:r,value:o[r]}));t.appendChild(this),t.submit();var n=(0,i.ge)("photo_file_button"+e);(0,g.lockButton)(n),setTimeout((function(){n.innerHTML=n.innerHTML}),0),(0,i.show)("photo_cancel"+e),(0,i.ge)("photo_cancel"+e).innerHTML=(0,C.getLang)("global_cancel"),e==cur.files.length-1&&X.addFile()}},fileDone(e,t){(0,i.hide)("photo_cancel"+e);for(var o="",r=e+1;r<cur.files.length;++r)if(cur.files[r].id&&!cur.files[r].deleting){o=cur.files[r].id;break}setTimeout(ajax.post.pbind("al_photos.php",(0,h.extend)({act:"done_add",before:o,context:1},AjaxConvert.fromQueryString(t)),{onDone:function(t,o){if(!t)return X.fileFail(e,0);cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont),(0,h.extend)(cur.files[e],{id:t,deleting:!1,cont:!1}),(0,i.ge)("photo_upload_row"+e).innerHTML=o,(0,d.autosizeSetup)("photo_caption"+t,{minHeight:30}),(0,i.show)("photo_delete"+t)},onFail:function(t){if(t)return setTimeout((0,_.showFastBox)({title:(0,C.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},t).hide,3e3),X.fileCancel(e),!0}}),0)},fileCancel(e,t){if(cur.files[e].cont&&(cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont)),!t){var o=(0,i.ge)("photo_file_button"+e);(0,g.unlockButton)(o),o.innerHTML=(0,C.getLang)("photos_choose_file"),cur.files[e]={},X.initFile(e),(0,i.hide)("photo_cancel"+e)}},fileFail(e,t){X.fileCancel(e)},fileDelete(e,t){for(var o=0;o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&!cur.files[o].deleting){cur.files[o].deleting=!0,ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:2},{onFail:function(){cur.files[o].deleting=!1}});var r=(0,i.ge)("photo_edit_row"+e);r.parentNode.insertBefore(X.genFile(o,"photos.fileRestore('"+e+"', '"+t+"')",(0,C.getLang)("global_restore")),r),(0,i.hide)(r),X.initFile(o),(0,i.show)("photo_cancel"+o)}},fileRestore(e,t){for(var o=0,r="";o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&cur.files[o].deleting&&-1!==cur.files[o].deleting){if(cur.files[o].cont)return X.fileCancel(o);for(var n=o+1;n<cur.files.length;++n)if(cur.files[n].id&&!cur.files[n].deleting){r=cur.files[n].id;break}cur.files[o].deleting=-1,ajax.post("al_photos.php",{act:"restore_photo",photo:e,hash:t,before:r,edit:2},{onDone:function(){cur.files[o].deleting=!1}});var a=(0,i.ge)("photo_edit_row"+e);(0,i.show)(a),(0,i.re)(a.previousSibling)}},filesDone(e){setTimeout(ajax.post.pbind("al_photos.php",(0,h.extend)({act:"done_add",context:2},AjaxConvert.fromQueryString(e))),0)},filesFail(){for(var e=0;e<cur.files.length;++e)X.fileCancel(e);cur.allcont.innerHTML="",utilsNode.removeChild(cur.allcont),cur.allcont=!1},chooseFlash(){if(n.browser.flash<10)return(0,s.animate)((0,i.ge)("photo_flash_needed"),{backgroundColor:"#FFEFE8",borderBottomColor:"#E89B88",borderLeftColor:"#E89B88",borderRightColor:"#E89B88",borderTopColor:"#E89B88"},100,(()=>{(0,s.animate)((0,i.ge)("photo_flash_needed"),{backgroundColor:"#FFFFFF",borderBottomColor:"#CCCCCC",borderLeftColor:"#CCCCCC",borderRightColor:"#CCCCCC",borderTopColor:"#CCCCCC"},500)}));cur.photoCheckFails=0,(0,i.show)("photo_flash_upload"),(0,i.hide)("photo_default_upload"),(0,i.hide)("photo_upload_unavailable")},chooseDefault(){cur.photoCheckFails=0,(0,i.show)("photo_default_upload"),(0,i.hide)("photo_flash_upload"),cur.serverChecked?((0,i.show)("photo_upload_files"),(0,i.hide)("photo_default_check")):((0,i.hide)("photo_upload_files"),(0,i.show)("photo_default_check"),cur.checkUpload())},flashWidth:()=>-1==_ua.indexOf("Mac")||-1==_ua.indexOf("Opera")&&-1==_ua.indexOf("Firefox")?"600":"601",activeTab(e){for(var t=(0,i.domPN)((0,i.domPN)(e)),o=(0,i.domFC)(t);o;o=(0,i.domNS)(o))(0,i.removeClass)(o,"active_link");(0,i.addClass)((0,i.domPN)(e),"active_link")},checkHtml5Uploader(){var e=window.XMLHttpRequest||window.XDomainRequest,t=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;return e&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&t))},upload:(e,t)=>t&&(2==t.button||t.ctrlKey)?(X.checkHtml5Uploader()&&(e.href+="&html5=1"),!0):!(void 0!==cur.uplId&&window.Upload&&Upload.checked&&Upload.checked[cur.uplId]&&X.checkHtml5Uploader())||((0,i.ge)("photos_upload_input").click(),!1),uploadLink:(e,t)=>(X.checkHtml5Uploader()&&(e.href+="&html5=1"),nav.go(e,t)),onUploadSelect(e){if((0,i.ge)("photos_upload_area")){window.filesToUpload=e;var t=(0,i.ge)("photos_upload_area").innerHTML;(0,i.ge)("photos_upload_area").innerHTML='<img src="/images/upload.gif">',nav.go((0,i.ge)("photos_upload_area").href+"&html5=1",!1,{onFail:function(e){return(0,i.ge)("photos_upload_area").innerHTML=t,setTimeout((0,_.showFastBox)({title:(0,C.getLang)("global_error"),dark:1,bodyStyle:"padding: 20px;"},e).hide,3e3),!0}})}},thumbOver(e,t,o){cur.hideTO&&cur.hideTO[t]&&clearTimeout(cur.hideTO[t]);var r=(0,i.geByClass1)("description",e),n=(0,i.geByClass1)("photo_album_title",e),a=(0,i.getSize)(r)[1];(0,s.animate)(n,{marginTop:163-(a?a+7:0)},{duration:200,transition:s.Fx.Transitions.easeOutCirc});var l=(0,i.geByClass1)("photo_album_info_back",e),d=(0,i.geByClass1)("photo_album_info_cont",e);if(l&&d)if(!l.over||o){var c=o?.6:.5,u=o?1:.8;o&&(l.over=1),(0,s.animate)(l,{opacity:c},{duration:200,transition:s.Fx.Transitions.easeOutCirc}),(0,s.animate)(d,{opacity:u},{duration:200,transition:s.Fx.Transitions.easeOutCirc})}else l.over=0},thumbOut(e,t,o){var r=(0,i.geByClass1)("photo_album_info_back",e),n=(0,i.geByClass1)("photo_album_info_cont",e),a=()=>{if(o){var t=(0,i.geByClass1)("photo_album_title",e);(0,s.animate)(t,{marginTop:163},200)}if(r&&n){var a=o?0:.5,l=o?0:.8;(0,s.animate)(r,{opacity:a},200),(0,s.animate)(n,{opacity:l},200)}};o?(cur.hideTO=cur.hideTO||{},cur.hideTO[t]=setTimeout(a,150)):a()},openEditor:(e,t)=>(window.stManager.add([window.jsc("web/photoview.js"),"photoview.css"],(function(){var t=(0,i.gpeByClass)("photos_photo_edit_row",e);cur.onPESave=function(e){(0,c.curBox)().hide(),(0,i.setStyle)((0,i.geByClass1)("photos_photo_edit_row_thumb",t),"background-image","url('"+e+"')"),cur.onPESave=!1,bodyNode.style.overflow="auto"};var o=t.getAttribute("data-id");Photoview.openEditor(o,cur.savedThumbs?cur.savedThumbs[o]:t.getAttribute("data-thumb"))})),(0,u.cancelEvent)(t)),addToAlbum(){cur.isPhotoUpload=!0,X.movePhotosBox(cur.savedPhotos||[],!1)},movePhotosBox(e,t,o,r){var n=[],s=!1;(0,a.isArray)(e)?n=e:(""===e&&t&&(e=(0,i.gpeByClass)("photos_photo_edit_row",t).getAttribute("data-id")),e?n.push(e):(0,h.each)((0,i.geByClass)("photos_edit_selected"),(function(){n.push(this.getAttribute("data-id"))})),s=(0,h.intval)(X._editGetSelectedCount()>n.length));var l=cur.album?cur.album.split("_"):[vk.id];return(0,_.showBox)("/al_photos.php",{act:"a_move_to_album_box",photo_ids:s?"":n.join(","),owner_id:l[0],from_album_id:l[1],all:s},{onDone:o}),(0,u.cancelEvent)(r)},cancelMove(e,t,o,r,n,a,s){var l=(0,i.gpeByClass)("photos_photo_edit_row",t);(0,i.re)((0,i.geByClass1)("photos_cancel_move",l)),X._showProgressPanel(l),ajax.post("al_photos.php",{act:"move_photos",photos:o,to_album_id:r,from_album_id:n,hash:s,owner_id:a},{onDone:function(){X._hideProgressPanel(l),cur.count++,X._editUpdateSelectedCounter()}}),(0,u.cancelEvent)(e)},doMovePhotos(e,t,o){var r=(0,i.domClosest)("_photos_album",t),n=(0,i.domData)(r,"aid"),a=(0,i.domData)(r,"from-aid"),s=(0,i.domData)(r,"owner-id"),l=(0,i.domData)(r,"move-hash"),d=(0,i.domData)(r,"from"),p=(0,i.geByClass1)("photos_album_counter",t),g=(0,i.geByClass1)("photos_album_thumb",t),_=(0,i.ge)("pv_move_to_album_progress");g.insertBefore(_,g.children[0]),(0,i.show)(_),(0,i.addClass)(t,"photos_in_progress"),(0,i.addClass)((0,i.gpeByClass)("photos_container_albums",t),"photos_inactive"),X.doEditBatchProcess({act:"move_photos",to_album_id:n,from_album_id:a,owner_id:s,hash:l,from:d},cur.editPhotosArray,(0,i.ge)("pv_move_to_album_progress"),"photos_move_in_progress_title",(function(e,t,r,l,d,c){cur.count=Math.max(cur.count-e,0),(0,i.val)(p,+(0,i.val)(p)+e),(0,h.each)(r,(function(e,t){var r=(0,i.ge)("photo_edit_row_"+t);if(!cur.isPhotoUpload)if(r&&!o){var l="return photos.cancelMove(event, this, '"+t+"', "+a+", "+n+", "+s+", '"+c+"')",d=(0,i.se)(`<div class="photos_cancel_move">\n                <div class="photos_editing_background"></div>\n                <a href="" onclick="${l}">${(0,C.getLang)("global_cancel")}</a></div>`);r.appendChild(d)}else(0,i.re)(r);cur.count=Math.max(cur.count,0)})),X._editUpdateSelectedCounter()}),(function(e,t){var r=(0,c.curBox)();r&&r.hide();var n=(0,C.langNumeric)(e,cur.lang.photos_x_photos_moved_no_cancel);(n=n.replace("{album}",t),(0,c.showDoneBox)(n),cur.pvShown&&cur.pvCurPhoto&&(cur.pvCurPhoto.album=t,(0,i.geByClass1)("pv_album_name").innerHTML=t),o||cur.isPhotoUpload)&&(0==cur.count?nav.reload():(0,i.geByClass)("photos_photo_edit_row").length<40&&X.load())})),e&&(0,u.cancelEvent)(e)},publishPhotos(e){if(cur.savedPhotos){cur.savingPhotos=!0;var t={act:"post",type:"photos_upload",to_id:vk.id,attach1_type:"photos_list",attach1:(cur.savedPhotos||[]).join(","),hash:cur.post_hash};ajax.post("/al_wall.php",t,{showProgress:()=>(0,g.lockButton)(e),onDone:function(){delete cur._back,nav.go("/id"+vk.id),(0,l.showBackLink)()}})}return!1},registerDragZone(e){(0,u.addEvent)(document,"dragenter dragover",(function(t){if(X.checkHtml5Uploader())return setTimeout((function(){clearTimeout(cur.dragTimer),delete cur.dragTimer}),0),e.on(t),(0,u.cancelEvent)(t)})),(0,u.addEvent)(document,"dragleave",(function(t){cur.dragTimer&&(clearTimeout(cur.dragTimer),delete cur.dragTimer),cur.dragTimer=setTimeout((function(){e.un(t)}),100),(0,u.cancelEvent)(t)})),(0,u.addEvent)(document,"drop",(function(t){return e.un(t,!0),e.drop(t.dataTransfer.files),(0,u.cancelEvent)(t)})),cur.destroy.push((function(){(0,u.removeEvent)(document,"dragenter dragover"),(0,u.removeEvent)(document,"dragleave"),(0,u.removeEvent)(document,"drop")}))},initTagBlock(e){void 0===e&&(e={});var t=document.querySelector(".PhotoTagBlock");if(t)try{var o=new O(t,e);window.cur.destroy.push((()=>o.destroy()))}catch(e){console.error(e),(0,L.logError)(e)}},albumGoUploaderPropsCache:{},initAlbumGoUploader(e,t){void 0===t&&(t=null);var o=t||this.albumGoUploaderPropsCache[e];if(o){this.albumGoUploaderPropsCache[e]=o;var r=o.userId,n=o.groupId,a=o.albumId,s=o.uploadUrl,l=o.endpoint,d=o.curData;d&&(0,h.extend)(window.cur,d);var c=(0,i.ge)("photos_upload_input"),u=(0,i.ge)("photos_upload_area_drop"),p=[],g=G(e,{uploadUrl:s,accept:$.ALBUM_GO_UPLOADER_ACCEPT_TYPES,multiple:!0,input:c,dropArea:u,dragOverClass:"photos_upload_area_enter",onLoadStart:e=>{p.length=0,(0,i.hide)("system_msg"),window.PhotosAdd.onUploadStart(e)},onProgress:e=>{Array.from((0,i.geByClass)("photos_period_delimiter_fixed")).forEach(i.hide),_()},onLoadEnd:(e,t)=>{var o=t[0],i={group_id:n,album_id:a,user_id:r,photos_json:JSON.stringify(o)};window.PhotosAdd.onImpUploadComplete(e,i,l,(()=>{p.push(...e),_(),g.nextBatch()}))},onLoadEndAll:(e,t)=>{window.PhotosAdd.onUploadCompleteAll(e,t,!1)},onError:(e,t,o)=>{(0,L.logError)(`${t}: ${o}`,{environment:"go_uploader"}),(0,M.topError)((0,C.getLang)("photos_upload_error"),{type:100});window.PhotosAdd.onImpUploadComplete(e,{},l),window.PhotosAdd.onUploadCompleteAll(null,null)}});window.photos.initAlbumGoUploaderDragZone(e),cur.nav.push((()=>(g.cancelAllUploads(),!0))),window.filesToUpload&&window.filesToUpload.length&&(g.manualUploadFiles([...window.filesToUpload]),delete window.filesToUpload)}function _(){var e=g.uploadedFiles.length,t=g.uploadedFiles[0].loadedSize,o=g.uploadedFiles[0].totalSize,r=p.length;if(r===e)window.PhotosAdd.hideUploadProgress(),(0,i.show)((0,i.ge)("photos_go_to_album"));else{var n=.1*(t/o)+.9*(r/e);window.PhotosAdd.updateProgressBar(n,r,e)}}},initAlbumGoUploaderDragZone(e){var t=R(e);this.onAlbumGoUploaderDragEnter=e=>{t.handleDragEnter(e)},window.document.addEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},detachAlbumGoUploaderDragZone(){window.document.removeEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},initChooseSelectGoUploader(e){var t=e.id,o=e.userId,r=e.groupId,i=e.albumId,n=e.uploadUrl,a=e.options,s=void 0===a?{}:a;new W.Upload({id:t,userId:o,groupId:r,albumId:i,uploadUrl:n,options:s})},showProfileBox:(e,t)=>((0,_.showBox)("al_places.php",{act:"photos_box",uid:e},{stat:["maps.js",window.jsc("web/places.js"),"places.css","ui_controls.js","ui_controls.css"]}),(0,u.cancelEvent)(t),!1),photosUploadOnInputChange:e=>{var t=window.cur.album,o=R(null!=t?t:"");e&&o?o.handleInputChange(e):(0,L.logError)(new Error(`Uploader "${t}" did not found`),{environment:"go_uploader"})}}},59266:(e,t,o)=>{"use strict";o.d(t,{GoUploaderDnD:()=>l});var r=o(70655),i=o(65641),n=o(51315),a=o(33321),s=o(92206),l=function(e){function t(t){var o,r=e.call(this,t)||this;return r.isDndActive=!1,r.dndTimer=-1,r.handleDrop=function(e){if(e.preventDefault(),e.stopPropagation(),r.onDragLeave&&r.onDragLeave(e),r.isDndActive=!1,e.dataTransfer){var t=r.getAcceptedFilesOnly(e.dataTransfer.files);r.manualUploadFiles(t)}},r.handleDragOver=function(e){e.preventDefault(),e.stopPropagation(),window.setTimeout((function(){window.clearTimeout(r.dndTimer),r.dndTimer=-1}),0)},r.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation(),-1!==r.dndTimer&&window.clearTimeout(r.dndTimer),r.dndTimer=window.setTimeout((function(){r.isDndActive=!1,r.onDragLeave&&r.onDragLeave(e)}),100)},r.handleDragEnter=function(e){e.preventDefault(),e.stopPropagation(),r.isDndActive||(window.setTimeout((function(){window.clearTimeout(r.dndTimer),r.dndTimer=-1}),0),r.isDndActive=!0,r.onDragEnter&&r.onDragEnter(e))},r.lazyInitDnD=null!==(o=t.lazyInitDnD)&&void 0!==o&&o,t.dropArea&&!r.lazyInitDnD&&r.initDropArea(t.dropArea),t.onDragEnter&&(r.onDragEnter=t.onDragEnter),t.onDragLeave&&(r.onDragLeave=t.onDragLeave),r}return(0,r.__extends)(t,e),t.prototype.initDropArea=function(e){e&&(this.dropArea=e,this.dropArea.addEventListener("dragleave",this.handleDragLeave),this.dropArea.addEventListener("dragenter",this.handleDragEnter),this.dropArea.addEventListener("dragover",this.handleDragOver),this.dropArea.addEventListener("drop",this.handleDrop))},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.dropArea&&(this.dropArea.removeEventListener("dragleave",this.handleDragLeave),this.dropArea.removeEventListener("dragenter",this.handleDragEnter),this.dropArea.removeEventListener("dragover",this.handleDragOver),this.dropArea.removeEventListener("drop",this.handleDrop))},t}(function(){function e(e){var t,o,r=this;this.multipleMaxSize=s.MULTIPLE_MAX_COUNT,this.multipleMaxBatchSize=s.MULTIPLE_BATCH_SIZE,this.uploadUrl="",this.uploadEvents=[],this.uploadMode=i.UploadMode.queue,this.uploaderTasksQueue=[],this.handleInputChange=function(e){var t=e.target.files;if(t&&0!==t.length){var o=r.getAcceptedFilesOnly(t);r.manualUploadFiles(o)}else(0,a.logError)(new Error("GoUploader lib: bad args in handleInputChange"),"No files in event")},this.accept=null!==(t=e.accept)&&void 0!==t?t:s.DEFAULT_ACCEPT,this.multiple=null!==(o=e.multiple)&&void 0!==o&&o,this.uploadUrl=e.uploadUrl,this.onBeforeUpload=e.onBeforeUpload,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.multipleMaxSize&&e.multipleMaxSize>0&&e.multipleMaxSize<=s.MULTIPLE_MAX_COUNT&&(this.multipleMaxSize=e.multipleMaxSize),e.multipleMaxBatchSize&&(this.multipleMaxBatchSize=e.multipleMaxBatchSize)}return e.prototype.cancelUpload=function(e){e.cancelled=!0},e.prototype.cancelAllUploads=function(){var e=this;this.uploadEvents.forEach((function(t){e.cancelUpload(t)}))},e.prototype.startFilesUpload=function(e,t){var o=this,r=this.multiple?this.multipleMaxSize:1,n=t.reduce((function(e,t){if(!e.length)return e.push([t]),e;var i=e.length-1,n=e[i].length,a=e[i].reduce((function(e,t){return e+=t.size}),0);return n<r&&a<o.multipleMaxBatchSize?e[i].push(t):e.push([t]),e}),[]),a=0;this.uploadEvents=n.map((function(e){var t=0,r=e.reduce((function(e,r,i){var n=o.multiple?"file"+(i+1):"file";return t+=r.size,a++,e[n]={file:r,fileName:r.name,ind:a,loadedSize:0,fileSize:r.size},e}),{});return{totalSize:t,loadedSize:0,totalCount:e.length,uploaded:!1,cancelled:!1,files:r}})),this.onLoadStart&&this.uploadEvents.forEach((function(e){var t;null===(t=o.onLoadStart)||void 0===t||t.call(o,e)}));var s=[];return this.uploadMode===i.UploadMode.parallel?this.uploadEvents.forEach((function(t){s.push(o.sendUploadRequest(e,t))})):(this.uploadEvents.forEach((function(t){s.push(new Promise((function(r){o.uploaderTasksQueue.push((function(){return o.sendUploadRequest(e,t).then((function(e){return r(e),e}))}))})))})),this.nextBatch()),Promise.all(s)},e.prototype.nextBatch=function(){var e=this.uploaderTasksQueue.shift();e&&e()},e.prototype.sendUploadRequest=function(t,o){var r=this,i=new FormData;Object.keys(o.files).forEach((function(e){var t=o.files[e];i.append(e,t.file)}));return(0,n.sendUploadRequest)(t,i,(function(e){var t,i=e.loaded;o.loadedSize=i,Object.keys(o.files).forEach((function(e){var t=o.files[e];if(i>0){var r=0;i>=t.fileSize?(r=t.fileSize,i-=t.fileSize):(r=i,i=0),t.loadedSize=r}})),null===(t=r.onProgress)||void 0===t||t.call(r,o)})).then((function(t){var i,n,s;o.uploaded=!0;try{s=JSON.parse(t)}catch(o){(0,a.logError)(o,"parse json error",{json:t}),s={error_code:e.ERROR_PARSE_JSON,error_msg:"Response parse error"}}return o.responseString=t,o.response=s,"files"in s&&s.files&&Object.keys(s.files).forEach((function(e){var t,r,i;"files"in s&&s.files&&(null===(t=s.files[e])||void 0===t?void 0:t.error_code)&&(o.files[e].errorCode=null===(r=s.files[e])||void 0===r?void 0:r.error_code,o.files[e].errorMessage=null===(i=s.files[e])||void 0===i?void 0:i.error_msg)})),"error_code"in s?(o.errorCode=s.error_code,o.errorMessage=s.error_msg,null===(i=r.onError)||void 0===i||i.call(r,o)):null===(n=r.onLoadEnd)||void 0===n||n.call(r,o),o})).catch((function(t){return(0,a.logError)(t,"js syntax error"),o.errorCode=e.ERROR_JS,o.errorMessage="Unknown Error ("+t+")",o}))},e.prototype.initFileInput=function(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")},e.prototype.getAcceptedFilesOnly=function(e){var t=this;return Array.from(e).filter((function(e){return(0,a.acceptFile)(e,t.accept)}))},e.prototype.cleanupFields=function(){this.input&&(this.input.value=""),this.uploadEvents=[]},e.prototype.uploadFiles=function(e){var t=this;return this.beforeUpload(e).then((function(e){return t.startFilesUpload(t.uploadUrl,e)}))},e.prototype.beforeUpload=function(e){return this.onBeforeUpload?this.onBeforeUpload(e):Promise.resolve(e)},e.prototype.manualUploadFiles=function(e){var t=this;e.length?this.uploadFiles(e).then((function(e){var o;t.uploadEvents.filter((function(e){return!e.cancelled})).length&&(null===(o=t.onLoadEndAll)||void 0===o||o.call(t,e))})).finally((function(){t.cleanupFields()})):this.cleanupFields()},e.prototype.destroy=function(){},e.ERROR_JS=-1,e.ERROR_PARSE_JSON=-2,e}())},92206:(e,t,o)=>{"use strict";o.d(t,{DEFAULT_ACCEPT:()=>r,MULTIPLE_BATCH_SIZE:()=>i,MULTIPLE_MAX_COUNT:()=>n});var r=["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],i=5242880,n=5},33321:(e,t,o)=>{"use strict";o.d(t,{ALBUM_GO_UPLOADER_ACCEPT_TYPES:()=>n,logError:()=>a,acceptFile:()=>s});var r=o(91525),i=o(9509),n=["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],a=function(e,t,o){void 0===t&&(t="unknown"),void 0===o&&(o={});var n={environment:"goUploader",breadcrumb:{message:t,data:o,category:i.customBreadcrumbCategory}};(0,r.logError)(e,n)},s=function(e,t){if(e&&t){var o=e.name||"",r=(e.type||"").toLowerCase(),i=r.replace(/\/.*$/,"");return t.some((function(e){var t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):r===t}))}return!0}},8069:(e,t,o)=>{"use strict";o.d(t,{GoUploaderHelper:()=>n});var r=o(59266),i=new Map,n={getUploader:function(e){return i.get(e)},init:function(e,t){if(i.has(e)){var o=i.get(e);o&&o.destroy()}var n=new r.GoUploaderDnD(t);return i.set(e,n),n}}},65641:(e,t,o)=>{"use strict";var r;o.d(t,{UploadMode:()=>r}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(r||(r={}))},51315:(e,t,o)=>{"use strict";o.d(t,{sendUploadRequest:()=>r});var r=function(e,t,o){return new Promise((function(r,i){var n=new XMLHttpRequest;n.open("POST",e,!0),n.upload.onloadstart=function(e){o(e)},n.upload.onprogress=function(e){o(e)},n.onerror=function(){i("Unknown error")},n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&(200===n.status?r(n.responseText):i())},n.send(t)}))}},65931:(e,t,o)=>{"use strict";o.d(t,{decrementLeftMenuPhotoCounter:()=>s});var r=o(95724),i=o(91525),n=o(66890),a="ph";function s(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?(0,r.intval)(t.textContent):0}();(0,n.handlePageCount)(a,Math.max(t-e,0))}catch(e){console.error(e),(0,i.logError)(e)}}},23251:(e,t,o)=>{"use strict";var r;o.d(t,{TagEventTypes:()=>r}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(r||(r={}))}}]);try{stManager.done("dist/ed02da901f6e6d717716f8686f741618.4c54dd29c07850d4a80e.js")}catch(e){}