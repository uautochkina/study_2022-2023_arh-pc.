(()=>{"use strict";var e,t,s,i={94614:(e,t,s)=>{s(51876),s(59357),s(91181),s(56997),s(96253),s(19371);var i=s(15544),o=s(95724),a=s(49535),r=s(54612),n=s(86067),d=(s(50110),s(98837),s(76142),s(66108),s(91789)),h=s(26271),l=s(40906),g=s(18149),u="friends_dropdown__list_item",c="friends_dropdown__list_item system_message",p="add_term_tag";const v=class{constructor(e){void 0===e&&(e={}),this.options=(0,o.extend)({onUserSelected:()=>!1,onEscapePress:()=>!1,onKeyUp:()=>!1},e),cur.pvServerFriendsIndex&&cur.pvServerFriendsIds||(cur.pvServerFriendsIndex=new g.vkIndexer([],(e=>{e[0];return e[1]})),cur.pvServerFriendsIds=[]),this.topUsers=new g.vkIndexer([],(e=>{e[0];return e[1]})),this.isInited=!1,this.lastSeachTerm="",this.hoverItem=null,this.keyboardNavigation=!1,this.freeTerm=null,this._handleInputKeyEvent=this._handleInputKeyEvent.bind(this),this._handleMouseMoveOnce=this._handleMouseMoveOnce.bind(this)}init(){this.isInited&&this.friendsdListNode||((0,d.getIndexedFriends)()||this.fetchFriendsList(),this.isInited=!0,this._initElement(),this._initScroll());return this.friendsdListNode}update(e){void 0===e&&(e=[]),this._resetScroll(),this.setTopUsers(e),this._hideDropdown()}setTopUsers(e){this.topUsers.list.forEach((e=>{this.topUsers.remove(e)})),e.forEach((e=>{this.topUsers.add(e)})),this.topUsers.list=e}_hideDropdown(){(0,i.removeClass)(this.friendsdListNode,"show-dropdown")}_getItemHtml(e,t,s,i){return`<div class="${u}" data-id="${e}" data-name="${t}">\n      <img src="${i}" alt="${t}" class="friends_dropdown__list_image">\n      <div class="friends_dropdown__list_info">\n        <div class="friends_dropdown__list_name">${t} ${e===vk.id.toString()?`(${(0,n.getLang)("photos_tags_user_you")})`:""}</div>\n        <div class="friends_dropdown__list_label">${s}</div>\n      </div>\n    </div>`}_initElement(){this.friendsdListNode=(0,i.ce)("div",{className:"friends_dropdown__list"}),this.listInput=(0,i.ce)("input",{className:"friends_dropdown__list_input",placeholder:`${(0,l.replaceEntities)((0,n.getLang)("photos_tags_dropdown_placeholder"))}`}),this.listDropdown=(0,i.ce)("div",{className:"friends_dropdown__list_dropdown"}),this.listContent=(0,i.ce)("div",{className:"friends_dropdown__list_content"}),this.listDropdown.appendChild(this.listContent),this.friendsdListNode.appendChild(this.listInput),this.friendsdListNode.appendChild(this.listDropdown),this._setListHTML(`<div class="${c}">${(0,n.getLang)("box_loading")}</div>`),(0,a.addEvent)(this.friendsdListNode,"click",cancelEvent),(0,a.addEvent)(this.listDropdown,"click",(e=>{this._handleItemSelected(e.target)})),(0,a.addEvent)(this.listDropdown,"mouseover",(e=>{if(!this.keyboardNavigation){var t=(0,i.hasClass)(e.target,u)?e.target:(0,i.gpeByClass)(u,e.target);this._setHoverItem(t)}})),(0,a.addEvent)(this.listInput,"keyup keydown keypress",this._handleInputKeyEvent),(0,a.addEvent)(this.listInput,"click",(()=>{this.show()}))}_handleItemSelected(e){var t=(0,i.hasClass)(e,u)?e:(0,i.gpeByClass)(u,e),s=(0,i.domData)(t,"name"),o=(0,i.domData)(t,"id");o&&this.options.onUserSelected(o,s),(0,i.hasClass)(e,p)&&this.freeTerm&&this.options.onUserSelected(0,this.freeTerm)}_getItemEleById(e){return(0,i.domQuery1)(`[data-id="${e}"]`,this.listDropdown)}_setListHTML(e){(this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent).innerHTML=e}_setHoverItem(e,t){void 0===t&&(t=!1);var s=(0,i.domData)(e,"id");if(s&&s!==this.hoverItem){if(this.hoverItem){var o=this._getItemEleById(this.hoverItem);(0,i.removeClass)(o,"hover")}this.hoverItem=s,(0,i.addClass)(e,"hover"),t&&this.scroll&&this.scroll&&this.scroll.scrollIntoView(e)}}show(e){(0,i.hasClass)(this.friendsdListNode,"show-dropdown")||(this._renderFriendsList(this.lastSeachTerm,e),(0,i.addClass)(this.friendsdListNode,"show-dropdown"),this._resetScroll(),this.scroll&&this.scroll.update())}_renderFriendsList(e,t){if(void 0===t&&(t=!1),e=(0,o.trim)(e),(0,d.getIndexedFriends)()){var s=this._doSearch(e);this._renderFriendsDropdown(e,s,t)}else this._setListHTML(`<div class="${c}">${(0,n.getLang)("box_loading")}</div>`);clearTimeout(this.requestTimeout),e.length>0&&e!==this.lastSeachTerm&&(this.requestTimeout=setTimeout((()=>{this.fetchFriendsWithQuery(e)}),300))}_initScroll(){h.browser.safari||window.stManager.add(["ui_common.css","ui_common.js"],(()=>{this.scroll=new window.uiScroll(this.listContent,{global:!0})}))}_handleInputKeyEvent(e){if("keyup"===e.type){switch(e.keyCode){case a.KEY.ENTER:this._handleEnter();break;case a.KEY.ESC:return this.options.onEscapePress(),void this._hideDropdown();default:var t=e&&e.target.value;t!==this.lastSeachTerm&&(this._renderFriendsList(t),this.lastSeachTerm=t,this.hoverItem=null)}this.options.onKeyUp(),this.show()}else switch(e.keyCode){case a.KEY.UP:case a.KEY.DOWN:this._handleArrows(e.keyCode===a.KEY.DOWN)}}_handleArrows(e){var t,s;if(void 0===e&&(e=!0),this.keyboardNavigation||(this.keyboardNavigation=!0,(0,a.addEvent)(this.listDropdown,"mousemove",this._handleMouseMoveOnce)),this.hoverItem)t=this._getItemEleById(this.hoverItem),s=e?(0,i.domNS)(t):(0,i.domPS)(t);else{var o=this.listContent.__uiScroll__?this.listContent.__uiScroll__.content:this.listContent;s=(0,i.domFC)(o)}s&&this._setHoverItem(s,!0)}_handleMouseMoveOnce(){this.keyboardNavigation=!1,(0,a.removeEvent)(this.listDropdown,"mousemove",this._handleMouseMoveOnce)}_handleEnter(){if(this.hoverItem){var e=this._getItemEleById(this.hoverItem);this._handleItemSelected(e)}}_doSearch(e){var t;void 0===e&&(e="");var s,i,o,a=(0,d.getPhotoData)("tagged"),r=(0,d.getIndexedFriends)();e.length>0?(s=this.topUsers.search(e),i=r.search(e),o=cur.pvServerFriendsIndex.search(e)):(s=this.topUsers.list,i=r.list,o=cur.pvServerFriendsIndex.list),t=s.concat(i,o);var n=[];return(t=t.filter((e=>{var t=e[0],s=n.indexOf(t)<0&&(!a||!a[t]);return n.push(t),s}))).length>20&&(t=t.slice(0,20)),t}_renderFriendsDropdown(e,t,s){void 0===s&&(s=!1);var i="";if(t.forEach((e=>{var t=e[0],s=e[1],o=e[2],a=e[3],r=`id${t}`;i+=this._getItemHtml(t,s,o,a,r)})),!i&&s){this.freeTerm=e,e=(0,l.clean)(e);var o=(0,n.getLang)("photos_tags_not_found_tag_text").replace("{tagName}",`<span class="add_term_tag">${e}</span>`);i=`<div class="${c}">${o}</div>`,this._setListHTML(i)}else i&&(this._setListHTML(i),this.freeTerm=null,this._resetScroll());this.hoverItem=null}focus(){this.listInput.focus()}reset(){this.listInput.value="",this.lastSeachTerm="",this.hoverItem=null,this._resetScroll()}_resetScroll(){this.scroll?this.scroll.scrollTop():this.listContent.scrollTop=0}fetchFriendsList(){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags"},{onDone:e=>{(0,d.setIndexedFriends)(e,(()=>{this._renderFriendsList(this.lastSeachTerm)}))}})}fetchFriendsWithQuery(e){ajax.post("hints.php",{act:"a_json_friends",from:"photo_tags",str:e,photo:(0,d.getPhotoData)("id")},{onDone:t=>{this._handleFetchFriends(e,t)}})}_handleFetchFriends(e,t){if(void 0===t&&(t=[]),this.lastSeachTerm===e){var s,i=0,o=(0,d.getPhotoData)("tagged");(s=o?t.filter((e=>{var t=e[0];return!o[t]})):t).forEach((e=>{var t=e[0];cur.pvServerFriendsIds.indexOf(t)<0&&(cur.pvServerFriendsIds.push(t),cur.pvServerFriendsIndex.add(e),i++)})),(i>0||0===s.length)&&this._renderFriendsList(e,!0)}}};var _="right_top";const m=class{constructor(e,t){void 0===t&&(t={}),this.options=(0,o.extend)({closeOnClick:!0,resetDropdownOnShow:!0,onUserSelected:()=>!1,onMouseLeave:()=>!1,onEscapePressed:()=>!1,onDeleteClicked:()=>!1,onSuggestionDeclined:()=>!1},t),this.container=e,this.friendsDropdown=new v({onUserSelected:this._handleUserSelected.bind(this),onEscapePress:this._handleEscapePress.bind(this),onKeyUp:this._handleStartInteraction.bind(this)}),this.friendsDropdownNode=this.friendsDropdown.init(),this._handleConfirmedTooltipClick=this._handleConfirmedTooltipClick.bind(this),this._handleDocumentClick=this._handleDocumentClick.bind(this),this.renderTooltip()}renderTooltip(){this.tooltipNode=(0,i.ce)("div",{className:"photo_tooltip"},{display:"none"});var e=(0,i.ce)("div",{className:"photo_tooltip__content"});this.sugggestionNode=(0,i.ce)("div"),this.nameNode=(0,i.ce)("div",{className:"photo_tooltip__name"},{display:"none"}),this.listNode=(0,i.ce)("div",{className:"photo_tooltip__suggestion"}),this.listNode.appendChild(this.friendsDropdownNode),(0,a.addEvent)(this.nameNode,"click",this._handleConfirmedTooltipClick),e.appendChild(this.nameNode),e.appendChild(this.sugggestionNode),e.appendChild(this.listNode),this.tooltipNode.appendChild(e),this.container.appendChild(this.tooltipNode),(0,a.addEvent)(this.tooltipNode,"mouseenter",(()=>{this.isActive=!0})),(0,a.addEvent)(this.sugggestionNode,"click",(e=>{switch((0,a.cancelEvent)(e),(0,i.domData)(e.target,"button")){case"yes":this.options.onUserSelected(this.suggestedUserId,this.suggestedUserName,!0);break;case"no":this.options.onSuggestionDeclined(),(0,i.hide)(this.sugggestionNode),this.userHref=null,this.options.hideAfterDecline?this.hide():(this.showFriendsList(),this.showAndFocusFriendsList())}})),(0,a.addEvent)(this.tooltipNode,"mouseleave",(()=>{this.interaction||(this.isActive=!1,this.options.onMouseLeave())})),this.options.closeOnClick&&(0,a.addEvent)(document,"click",this._handleDocumentClick)}_handleDocumentClick(e){this.options.onMouseLeave(),this.interaction=!1,this.isActive=!1,this.hide()}_handleUserSelected(e,t){this.isActive=!1,this.options.onUserSelected(e,t)}_handleEscapePress(){this.isActive=!1,this.interaction=!1,this.friendsDropdown.reset(),this.options.onEscapePressed()}_handleStartInteraction(){this.interaction=!0}_handleConfirmedTooltipClick(e){(0,a.cancelEvent)(e),"button"===e.target.tagName.toLowerCase()?this.options.onDeleteClicked():this.userHref&&this._go(this.userHref,e)}updatePosition(e){var t=e.top,s=e.right,o=e.bottom,a=e.left,r=s-a,n=(0,i.getSize)(this.tooltipNode),d=n[0]?n[0]:280,h="bottom",l=a+Math.floor(r/2)-d/2,g=o;if((l<10||this.hasDropdown&&o>(0,i.clientHeight)()-300)&&(h=_),h===_){l=s,g=t;var u=(0,i.clientHeight)()-t;u<300&&(g=t-300+u)}(0,i.domData)(this.tooltipNode,"dir",h),(0,i.setStyle)(this.tooltipNode,{top:g,left:l})}updateSuggestionQuestion(e,t){this.sugggestionNode.innerHTML=this._getSuggestionHTML(e,t),this.suggestedUserName=t,this.suggestedUserId=e}_getSuggestionHTML(e,t){var s=e===vk.id?(0,n.getLang)("photos_tags_user_you"):t;return`<div class="suggested_tag_user">\n      ${(0,n.langTag)("<div>","</div>",(0,n.getLang)("photos_tags_suggestion_question"),"tag_span").replace("{userName}",`<div class="suggested_tag_user__name">&nbsp;${s}</div>`)}\n      <div class="suggested_tag_user__actions">\n        <button data-button="yes" class="yes">${(0,n.getLang)("box_yes")}</button>\n        <span>&middot;</span>\n        <button data-button="no">${(0,n.getLang)("box_no")}</button>\n      </div>\n    </div>`}updateState(e){var t=e.suggestedUserName,s=e.suggestedUserId,o=e.usersList,a=e.userName,r=e.userHref,n=e.canDeleteTag;this.suggestedUserName=!1,this.suggestedUserId=!1,this.userHref=r,this.hasDropdown=!1,(0,i.removeClass)(this.tooltipNode,"tagged"),a?(this.nameNode.innerHTML=`${a} ${n?"<button>Delete</button>":""}`,(0,i.toggleClass)(this.nameNode,"show_delete",n),(0,i.show)(this.nameNode),(0,i.hide)(this.listNode),(0,i.hide)(this.sugggestionNode),(0,i.addClass)(this.tooltipNode,"tagged")):s?(this.updateSuggestionQuestion(s,t),(0,i.hide)(this.nameNode),(0,i.hide)(this.listNode),(0,i.show)(this.sugggestionNode)):(this.friendsDropdown.update(o),(0,i.hide)(this.nameNode),(0,i.hide)(this.sugggestionNode),this.showFriendsList(),this.hasDropdown=!0)}showFriendsList(){(0,i.show)(this.listNode),this.options.resetDropdownOnShow&&this.resetFriendsDropdown()}resetFriendsDropdown(){this.friendsDropdown.reset()}show(e,t,s){void 0===t&&(t={}),void 0===s&&(s=!1),this.isActive=!1,this.interaction=!1,this.updateState(t),this.updatePosition(e),(0,i.show)(this.tooltipNode),s&&this.friendsDropdown.show(!0),this.friendsDropdown.focus()}hide(){(0,i.hide)(this.tooltipNode)}showAndFocusFriendsList(e){this.userHref?this._go(this.userHref,e):(this.friendsDropdown.focus(),this.friendsDropdown.show())}unMount(){(0,a.removeEvent)(document,"click",this._handleDocumentClick),(0,i.re)(this.tooltipNode)}_go(e,t){t&&t.ctrlKey?window.open(e):nav.go(e,t)}};var f;!function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(f||(f={}));var w=s(19331),T=s(91525),S=s(66890),I="ph";function A(e){void 0===e&&(e=1);try{var t=function(){var e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");var t=e.querySelector(".left_count");return t?(0,o.intval)(t.textContent):0}();(0,S.handlePageCount)(I,Math.max(t-e,0))}catch(e){console.error(e),(0,T.logError)(e)}}var C="area_hover",N="visible_all";const E=class{constructor(e,t){this.imageNode=e,this.containerNode=t,this.activeAreaId=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this._handleImageMouseMove=this._handleImageMouseMove.bind(this),this._handleAreaClick=this._handleAreaClick.bind(this),this._removeActiveAreaAfterTimeout=this._removeActiveAreaAfterTimeout.bind(this),this._queueCheckUpdates=this._queueCheckUpdates.bind(this),this._queueReceiveUpdates=this._queueReceiveUpdates.bind(this),this._userSelectedCallback=this._userSelectedCallback.bind(this),this._handleSuggestionDeclined=this._handleSuggestionDeclined.bind(this),this.updatePhotoViewTags=this.updatePhotoViewTags.bind(this),this.deleteTag=this.deleteTag.bind(this),this._init(),this._queueCheckUpdates()}_init(){var e=(0,w.partConfigEnabled)("photo_recognition_web");this.photoTooltip=new m(window.layer,{onMouseLeave:this._removeActiveAreaAfterTimeout,onUserSelected:this._userSelectedCallback,onDeleteClicked:this.deleteTag,onEscapePressed:this._removeActiveAreaAfterTimeout,onSuggestionDeclined:this._handleSuggestionDeclined,hideAfterDecline:e}),this.photoView=window.Photoview,this.areasContainer=(0,i.ce)("div",{className:"photo_tags_suggested_areas_list"}),this.containerNode.innerHTML="",this.containerNode.appendChild(this.areasContainer),(0,a.addEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.addEvent)(this.imageNode,"mouseleave",this._removeActiveAreaAfterTimeout),(0,a.addEvent)(this.imageNode,"mouseenter",this.showAllSuggestedAreas.bind(this)),(0,a.addEvent)(this.areasContainer,"mouseleave",this._removeActiveAreaAfterTimeout),(0,a.addEvent)(this.areasContainer,"click",this._handleAreaClick),this.renderTagAreas()}_handleImageMouseMove(e){if(!this.areasHidden){var t=(0,i.getXY)(e.target),s=Math.round(100*(e.pageX-t[0])/e.target.offsetWidth),o=Math.round(100*(e.pageY-t[1])/e.target.offsetHeight);for(var a in clearTimeout(this.areasTimeOut),this.areasTimeOut=setTimeout((()=>{this.photoTooltip.isActive||this.activeAreaId||this.hideAllSuggestedAreas()}),700),this.showAllSuggestedAreas(),this.areas)if(this.areas.hasOwnProperty(a)){var r=this.areas[a],n=r.x,d=r.y,h=r.x2,l=r.y2;if(s>parseInt(n)&&s<parseInt(h)&&o>parseInt(d)&&o<parseInt(l)){if(a===this.activeAreaId)return void(this.tagAreaFound=!0);if(this.tagAreaFound=this.showTagArea(a),this.tagAreaFound)return}}this.tagAreaFound=!1,this._removeActiveAreaAfterTimeout()}}_handleAreaClick(e){(0,a.cancelEvent)(e),this.photoTooltip.showAndFocusFriendsList(e)}showTagArea(e){var t=this.areas[e];return!(!t||t.isDeleted)&&(null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=e,(0,i.addClass)(this.areas[e].ele,"active"),this.showTooltip(e),this.showAllSuggestedAreas(),!0)}hideTagArea(){clearTimeout(this.waitTimeout),null!==this.activeAreaId&&this.areas[this.activeAreaId]&&(0,i.removeClass)(this.areas[this.activeAreaId].ele,"active"),this.activeAreaId=null,this.photoTooltip.hide(),this.hideAllSuggestedAreas()}_removeActiveAreaAfterTimeout(e){void 0===e&&(e=500),this.activeAreaId&&!this.waitToRemove&&(this.waitToRemove=!0,clearTimeout(this.waitTimeout),this.waitTimeout=setTimeout((()=>{!this.photoTooltip.isActive&&!this.tagAreaFound&&!this.photoTooltip.interaction&&this.hideTagArea(),this.waitToRemove=!1}),e))}showTooltip(e){if(!this.tooltipsPaused){var t=this.areas[e].ele,s=this._getTooltipOptions(e);if(t){var o=(0,i.getXYRect)(t,!0),a=o.top,r=o.right,n=o.bottom,d=o.left;this.photoTooltip.show({top:a,right:r,bottom:n,left:d},s)}}}showAllSuggestedAreas(){(0,i.addClass)(this.areasContainer,N),(0,i.removeClass)(this.areasContainer,C),this.activeAreaId&&(0,i.addClass)(this.areasContainer,C)}hideAllSuggestedAreas(){(0,i.removeClass)(this.areasContainer,N)}pauseTooltips(){this.hideTagArea(),this.tooltipsPaused=!0}resumeTooltips(){this.tooltipsPaused=!1}_createTagElement(e,t,s,o){var a=cur.pvPhWidth,r=cur.pvPhHeight/a,n=s-e,d=o-t,h=(0,i.ce)("div",{className:"photo_tags_suggested_area"},{left:`${e}%`,marginTop:r*t+"%",width:`${n}%`}),l=(0,i.ce)("div",{},{paddingBottom:100*r*(d/n)+"%"});return h.appendChild(l),h}renderTagAreas(){this.areas={},this.areasContainer.innerHTML="";var e=(0,d.getPhotoData)("tags"),t=(0,d.getPhotoData)("suggested_tags"),s=(0,w.partConfigEnabled)("photo_recognition_web");for(var i in!s&&cur.postTo&&cur.postTo<0&&(t=[]),e)if("0"!==i&&e.hasOwnProperty(i)){var o=e[i],a=o[0],r=o[1],n=o[2],h=o[3],l=o[4],g=o[5],u=o[6],c=this._createTagElement(a,r,n,h);this.areas[i]={ele:c,x:a,y:r,x2:n,y2:h,userName:l,userHref:g,canDeleteTag:Boolean(u),confirmedTag:!1},this.areasContainer.appendChild(c)}for(var p in t)if(p&&t.hasOwnProperty(p)){var v=t[p],_=v[0],m=v[1],f=v[2],T=v[3],S=v[4],I=v[5],A=v[6],C=this._createTagElement(_,m,f,T),N=void 0;S&&(N=`/id${S}`),this.areas[p]={ele:C,x:_,y:m,x2:f,y2:T,userHref:N,suggestedUserId:S,suggestedUserName:I,usersList:A,confirmedTag:!1},this.areasContainer.appendChild(C)}}_userSelectedCallback(e,t,s){void 0===s&&(s=!1);var i=(0,d.getPhotoData)("tags"),a=(0,d.getPhotoData)("suggested_tags"),r=(0,w.partConfigEnabled)("photo_recognition_web"),n=this.activeAreaId,h=this.areas[n],l=h.x,g=h.y,u=h.x2,c=h.y2,p=`/id${e}`,v=cur.pvAskForAutoTag&&s,_=(0,o.clean)(t),m={suggestedUserId:!1,suggestedUserName:!1,usersList:[],userId:e,userName:_,userHref:p,canDeleteTag:!0},f=this.activeAreaId;r?this.confirmSuggestedTags([n],(()=>{this.activeAreaId=f,this.photoTooltip.updateState(m),this.showTagArea(f),this._removeActiveAreaAfterTimeout(1e3)})):(i[n]=[l,g,u,c,_,p,!0],delete a[n],this._confirmSuggestedTag(n,e,t,r,(()=>{this.activeAreaId=f,this.areas[f]=(0,o.extend)(h,m),this.photoTooltip.updateState(m),this.showTagArea(f),this._removeActiveAreaAfterTimeout(1e3),v&&(cur.pvAskForAutoTag=!1,this.showSettingsBox())})))}showSettingsBox(){(0,r.showBox)("/al_photos.php",{act:"show_autotag_settings"},{params:{grey:!0,width:450,bodyStyle:{padding:0},hideButtons:!0,titleTransparent:!0},onDone:(e,t)=>{var s=e.bodyNode,i=s=>{e.hide(),window.ajax.post("/al_settings.php",{act:"a_change_autotag_friends",hash:t.hash,autotag_friends:s?1:0})};s.querySelector(".AutotagSettingsBox__yesButton").addEventListener("click",(()=>i(!0))),s.querySelector(".AutotagSettingsBox__noButton").addEventListener("click",(()=>i(!1)))}})}confirmAlert(e){void 0===e&&(e=!1);var t=cur.pvOneSuggestHintId,s=cur.pvOneSuggestHintHash;e?(t=cur.pvSomeSuggestsHintId,s=cur.pvSomeSuggestsHintHash,cur.pvNeedShowAlertForSomeSuggests=!1):cur.pvNeedShowAlertForOneSuggest=!1,window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:t,hash:s},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}deleteTag(e){e||(e=this.activeAreaId,this.photoView.deleteTag(e)),this.hideTagArea();var t=this.areas[e];e&&t&&(t=(0,o.extend)(t,{isDeleted:!0}),(0,i.addClass)(t.ele,"deleted"))}_getTooltipOptions(e){var t=this.areas[e],s=t.suggestedUserId,i=t.suggestedUserName;return{suggestedUserId:s,userName:t.userName,userHref:t.userHref,suggestedUserName:i,usersList:t.usersList,canDeleteTag:t.canDeleteTag}}_handleSuggestionDeclined(){var e=this.activeAreaId,t=this.areas[e];if(t){var s=(0,d.getPhotoData)("suggested_tags"),i=(0,w.partConfigEnabled)("photo_recognition_web");this.areas[e]=(0,o.extend)(t,{suggestedUserId:!1,suggestedUserName:!1,userHref:null}),s&&s[e]&&(s[e][4]=0),i?this.declineSuggestedTags([e]):(this.showTagArea(e),this._declineSuggestedTag(e))}}declineSuggestedTags(e,t,s){var o=(0,d.getPhotoData)("id"),a=(0,d.getPhotoData)("hash"),r=cur.pvListId,h=cur.pvIndex,l=cur.pvData[r][h],g=(0,d.getPhotoData)("tags"),u=e.map((e=>`${o}_${e}`)).join(",");ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:u,hash:a,extended:1},{onDone:(s,a,d)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewSuggestedTags(s,a,l),this.dispatchEvent(f.DECLINE_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:o}),r===cur.pvListId&&h===cur.pvIndex&&(!l.taginfo&&l.actions.tag&&g[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink),s||a||this.photoView.toggleTopInfoPanel((0,n.getLang)("photos_tag_deleted"),d)),t&&t()},onFail:e=>(e||(e=(0,n.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})}confirmSuggestedTags(e,t,s){var o=cur.pvListId,a=cur.pvIndex,h=cur.pvData[o][a],l=(0,d.getPhotoData)("id"),g=(0,d.getPhotoData)("hash"),u=(0,d.getPhotoData)("suggested_tags"),c=e.length>1,p=e[0],v=u[p][4],_=()=>{var r=e.map((e=>`${l}_${e}`)).join(",");ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:r,hash:g,extended:1},{onDone:(s,r,n,d,g)=>{this.decrementLeftMenuCounterIfNeeded(e),this.updatePhotoViewTags(s,r,n,h),this.updatePhotoViewSuggestedTags(d,g,h),this.dispatchEvent(f.CONFIRM_SUGGESTED_TAGS,{tagIds:e.map(Number),photoRawId:l}),o===cur.pvListId&&a===cur.pvIndex&&(!h.taginfo&&h.actions.tag&&s[0]<cur.pvMaxTags?(0,i.show)(cur.pvTagLink):(0,i.hide)(cur.pvTagLink)),t&&t()},onFail:e=>(e||(e=(0,n.getLang)("global_unknown_error")),s&&s(),this.handleTagRequestFail(e))})};if(cur.pvNeedShowAlertForOneSuggest&&!c&&v!==window.vk.id||cur.pvNeedShowAlertForSomeSuggests&&c){var m="",w="",T="";if(c){var S=e.reduce(((e,t)=>{var s=u[t],i=s&&s[4];return i&&i!==window.vk.id&&(e[i]=!0),e}),{}),I=Object.keys(S).length;w=(0,n.getLang)("photo_recognition_some_tag_alert",I),m=(0,n.getLang)("photo_recognition_some_friends_alert_text",I),T=(0,n.getLang)("photo_recognition_some_friends_submit_btn")}else{var A=u[p][5],C=u[p][7];w=(0,n.getLang)("photo_recognition_one_tag_alert"),m=(0,n.langSex)(C,(0,n.getLang)("photo_recognition_one_tag_alert_text","raw")).replace("{name}",A),T=(0,n.getLang)("photo_recognition_one_friend_submit_btn")}var N=(0,r.showFastBox)(w,m,T,(()=>{N.hide(),_(),this.confirmAlert(c)}),(0,n.getLang)("global_cancel"),(()=>{N.hide(),s&&s()}))}else _()}decrementLeftMenuCounterIfNeeded(e){var t=(0,d.getPhotoData)("suggested_tags");e.forEach((e=>{var s=t[e],i=s&&s[4];i&&i===window.vk.id&&A()}))}_confirmSuggestedTag(e,t,s,i,o){var a=(0,d.getPhotoData)("id"),r=(0,d.getPhotoData)("hash");ajax.post("al_photos.php",{act:"confirm_suggested_tag",tag:e,tagged_id:t,name:s,photo:a,hash:r},{onDone:(e,t,s)=>{this.updatePhotoViewTags(e,t,s),o()},onFail:this.handleTagRequestFail})}_declineSuggestedTag(e){var t=(0,d.getPhotoData)("id"),s=(0,d.getPhotoData)("hash");ajax.post("al_photos.php",{act:"decline_suggested_tag",tag:e,photo:t,hash:s},{onFail:this.handleTagRequestFail})}dispatchEvent(e,t){this.areasContainer.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}handleTagRequestFail(e){var t=(0,n.getLang)("global_error");return setTimeout((0,r.showFastBox)(t,e).hide,3e3),!0}unMount(){(0,a.removeEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.removeEvent)(this.areasContainer,"click",this._handleAreaClick),this.containerNode.innerHTML=""}hideAreas(){this.areasHidden=!0,(0,i.hide)(this.areasContainer),this.photoTooltip.hide()}showAreas(){this.areasHidden=!1,(0,i.show)(this.areasContainer),(0,a.removeEvent)(this.imageNode,"mousemove",this._handleImageMouseMove),(0,a.addEvent)(this.imageNode,"mousemove",this._handleImageMouseMove)}reload(e){void 0===e&&(e=null),this.hideTagArea(),this.resumeTooltips(),this.renderTagAreas(),e&&(this.imageNode=e),this.activeAreaId=null,this.waitToRemove=null,this.tagAreaFound=!1,this.areasHidden=!1,this.tooltipsPaused=!1,this.showAreas()}_queueCheckUpdates(){cur.pvTagsQueueParams&&window.Notifier&&Notifier.addKey(cur.pvTagsQueueParams,this._queueReceiveUpdates)}updatePhotoViewTags(e,t,s,i){void 0===i&&(i=null),(i=i||(0,d.getCurrentPhoto)())&&(i.tags=e,i.tagged=t,i.tagshtml=s,this.photoView.setTags(s))}updatePhotoViewSuggestedTags(e,t,s){void 0===s&&(s=null),(s=s||(0,d.getCurrentPhoto)())&&(e&&Object.keys(e).length?s.suggested_tags=e:delete s.suggested_tags,t?(s.suggestedTagsInfo=t,this.photoView.showSuggestedInfoTopPanel(cur.pvCurPhoto)):(delete s.suggestedTagsInfo,this.photoView.toggleTopInfoPanel(!1)),this.reload())}_queueReceiveUpdates(e,t){t.events&&t.events.forEach((e=>{var t=e.split("<!>"),s=t[1],i=t[2],o=JSON.parse(i),a=JSON.parse(t[3]),r=JSON.parse(t[4]),n=t[5];if((0,d.getPhotoData)("id")===s)(0,d.setPhotoData)("suggested_tags",o),this.updatePhotoViewTags(a,r,n),this.renderTagAreas();else if(cur.pvData){var h=function(e){if(cur.pvData.hasOwnProperty(e)){var t=cur.pvData[e];t.length&&t.forEach(((t,i)=>{if(t.id&&t.id===s){var d=cur.pvData[e][i];d.suggested_tags=o,d.tags=a,d.tagged=r,d.tagshtml=n}}))}};for(var l in cur.pvData)h(l)}}))}};window.PhotoTags=E,window.PhotoTooltip=m;try{window.stManager.done(window.jsc("web/photos_module.js"))}catch(e){}}},o={};function a(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={id:e,loaded:!1,exports:{}};return i[e].call(s.exports,s,s.exports,a),s.loaded=!0,s.exports}a.m=i,e=[],a.O=(t,s,i,o)=>{if(!s){var r=1/0;for(l=0;l<e.length;l++){for(var[s,i,o]=e[l],n=!0,d=0;d<s.length;d++)(!1&o||r>=o)&&Object.keys(a.O).every((e=>a.O[e](s[d])))?s.splice(d--,1):(n=!1,o<r&&(r=o));if(n){e.splice(l--,1);var h=i();void 0!==h&&(t=h)}}return t}o=o||0;for(var l=e.length;l>0&&e[l-1][2]>o;l--)e[l]=e[l-1];e[l]=[s,i,o]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},s=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,a.t=function(e,i){if(1&i&&(e=this(e)),8&i)return e;if("object"==typeof e&&e){if(4&i&&e.__esModule)return e;if(16&i&&"function"==typeof e.then)return e}var o=Object.create(null);a.r(o);var r={};t=t||[null,s({}),s([]),s(s)];for(var n=2&i&&e;"object"==typeof n&&!~t.indexOf(n);n=s(n))Object.getOwnPropertyNames(n).forEach((t=>r[t]=()=>e[t]));return r.default=()=>e,a.d(o,r),o},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.e=()=>Promise.resolve(),a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={22866:0};a.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[r,n,d]=s,h=0;for(i in n)a.o(n,i)&&(a.m[i]=n[i]);if(d)var l=d(a);for(t&&t(s);h<r.length;h++)o=r[h],a.o(e,o)&&e[o]&&e[o][0](),e[r[h]]=0;return a.O(l)},s=self.webpackChunkvk=self.webpackChunkvk||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var r=a.O(void 0,[76429,22897,75514,24509,40885,68592],(()=>a(94614)));r=a.O(r)})();